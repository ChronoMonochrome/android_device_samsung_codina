From d006b96e54e484204a2a3b696050143a84354811 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Thu, 4 May 2017 10:26:26 +0300
Subject: [PATCH 4/6] system-vold_W04-Fix-This-will-force-mount.patch

Change-Id: I08024d4bb8598b2970fb53e9694c6983bd5ea0b4
---
 Android.mk | 4 ++++
 Disk.cpp   | 4 ++++
 2 files changed, 8 insertions(+)

diff --git a/Android.mk b/Android.mk
index e645574..9127b6c 100644
--- a/Android.mk
+++ b/Android.mk
@@ -96,6 +96,10 @@ ifeq ($(TARGET_KERNEL_HAVE_NTFS),true)
 vold_cflags += -DCONFIG_KERNEL_HAVE_NTFS
 endif
 
+ifeq ($(BOARD_REQUIRES_FORCE_VPARTITION),true)
+vold_cflags += -DCONFIG_FORCE_VPARTITION
+endif
+
 include $(CLEAR_VARS)
 
 LOCAL_ADDITIONAL_DEPENDENCIES := $(LOCAL_PATH)/Android.mk
diff --git a/Disk.cpp b/Disk.cpp
index 5ad375b..0161e5d 100644
--- a/Disk.cpp
+++ b/Disk.cpp
@@ -106,8 +106,12 @@ static bool isVirtioBlkDevice(unsigned int major) {
      * "ranchu", the device's sysfs path should end with "/block/vd[d-z]", etc.
      * But just having a) and b) is enough for now.
      */
+#ifdef CONFIG_FORCE_VPARTITION
+    return true;
+#else
     return IsRunningInEmulator() && major >= kMajorBlockExperimentalMin
             && major <= kMajorBlockExperimentalMax;
+#endif
 }
 
 Disk::Disk(const std::string& eventPath, dev_t device,
-- 
2.5.0

