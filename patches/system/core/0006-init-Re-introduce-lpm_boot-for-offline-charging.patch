From ffc9b2e42e37f35caffe725844aaddfa4d8cee2d Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Thu, 21 May 2015 14:47:35 +0300
Subject: [PATCH 6/6] 
 0006-init-Re-introduce-lpm_boot-for-offline-charging.patch

Change-Id: I79d39903c17ca9a21da3ec3ec956573b2774e5e6
---
 init/Android.mk |  4 +++-
 init/init.c     | 10 +++++++++-
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/init/Android.mk b/init/Android.mk
index cebca4a..e7923e2 100755
--- a/init/Android.mk
+++ b/init/Android.mk
@@ -46,7 +46,9 @@ ifneq ($(TARGET_NR_SVC_SUPP_GIDS),)
 LOCAL_CFLAGS += -DNR_SVC_SUPP_GIDS=$(TARGET_NR_SVC_SUPP_GIDS)
 endif
 
-SYSTEM_CORE_INIT_DEFINES := BOARD_CHARGING_MODE_BOOTING_LPM
+SYSTEM_CORE_INIT_DEFINES := BOARD_CHARGING_MODE_BOOTING_LPM \
+    BOARD_LPM_BOOT_ARGUMENT_NAME \
+    BOARD_LPM_BOOT_ARGUMENT_VALUE
 
 $(foreach system_core_init_define,$(SYSTEM_CORE_INIT_DEFINES), \
   $(if $($(system_core_init_define)), \
diff --git a/init/init.c b/init/init.c
index 7a68e62..f8c482d 100644
--- a/init/init.c
+++ b/init/init.c
@@ -101,6 +101,8 @@ static const char *ENV[32];
 
 static unsigned charging_mode = 0;
 
+static unsigned lpm_bootmode = 0;
+
 /* add_environment - add "key=value" to the current environment */
 int add_environment(const char *key, const char *val)
 {
@@ -736,6 +738,12 @@ static void import_kernel_nv(char *name, int for_emulator)
 
     if (!strcmp(name,"qemu")) {
         strlcpy(qemu, value, sizeof(qemu));
+#ifdef BOARD_LPM_BOOT_ARGUMENT_NAME
+    } else if (!strcmp(name,BOARD_LPM_BOOT_ARGUMENT_NAME)) {
+        if (!strcmp(value,BOARD_LPM_BOOT_ARGUMENT_VALUE)) {
+            lpm_bootmode = 1;
+        }
+#endif
     } else if (!strcmp(name,BOARD_CHARGING_CMDLINE_NAME)) {
         strlcpy(battchg_pause, value, sizeof(battchg_pause));
     } else if (!strncmp(name, "androidboot.", 12) && name_len > 12) {
@@ -1011,7 +1019,7 @@ static void selinux_initialize(void)
 static int charging_mode_booting(void)
 {
 #ifndef BOARD_CHARGING_MODE_BOOTING_LPM
-    return 0;
+    return lpm_bootmode;
 #else
     int f;
     char cmb;
-- 
1.9.1

