From af2e769e7d44304b85a9f2c55ba4ada912d95589 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Fri, 4 Sep 2015 18:53:31 +0300
Subject: [PATCH 5/8] 0005-init-add-detection-of-charging-mode.patch

Change-Id: Ic37bc6eb8492f7fc97ed9068d85980da14cbf9f9
---
 init/Android.mk |  8 ++++++++
 init/init.c     | 21 ++++++++++++++++++++-
 2 files changed, 28 insertions(+), 1 deletion(-)
 mode change 100644 => 100755 init/Android.mk

diff --git a/init/Android.mk b/init/Android.mk
old mode 100644
new mode 100755
index 228e645..4f55c01
--- a/init/Android.mk
+++ b/init/Android.mk
@@ -31,6 +31,14 @@ endif
 # Enable ueventd logging
 #LOCAL_CFLAGS += -DLOG_UEVENTS=1
 
+SYSTEM_CORE_INIT_DEFINES := BOARD_CHARGING_MODE_BOOTING_LPM
+
+$(foreach system_core_init_define,$(SYSTEM_CORE_INIT_DEFINES), \
+  $(if $($(system_core_init_define)), \
+    $(eval LOCAL_CFLAGS += -D$(system_core_init_define)=\"$($(system_core_init_define))\") \
+  ) \
+)
+
 LOCAL_MODULE:= init
 
 LOCAL_FORCE_STATIC_EXECUTABLE := true
diff --git a/init/init.c b/init/init.c
index f901153..cd1acb2 100644
--- a/init/init.c
+++ b/init/init.c
@@ -1001,6 +1001,25 @@ static void selinux_initialize(void)
     security_setenforce(is_enforcing);
 }
 
+static int charging_mode_booting(void)
+{
+#ifndef BOARD_CHARGING_MODE_BOOTING_LPM
+    return 0;
+#else
+    int f;
+    char cmb;
+    f = open(BOARD_CHARGING_MODE_BOOTING_LPM, O_RDONLY);
+    if (f < 0)
+        return 0;
+
+    if (1 != read(f, (void *)&cmb,1))
+        return 0;
+
+    close(f);
+    return ('1' == cmb);
+#endif
+}
+
 int main(int argc, char **argv)
 {
     int fd_count = 0;
@@ -1071,7 +1090,7 @@ int main(int argc, char **argv)
     restorecon("/dev/__properties__");
     restorecon_recursive("/sys");
 
-    is_charger = !strcmp(bootmode, "charger");
+    is_charger = !strcmp(bootmode, "charger") || charging_mode_booting();
 
     INFO("property init\n");
     property_load_boot_defaults();
-- 
1.9.1

