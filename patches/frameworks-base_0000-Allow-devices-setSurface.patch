Subject: [PATCH] hwui: Allow devices to opt-out of asynchronouse setSurface initialization

Not all devices seem to be able to deal with this so let them opt
out of it, even though it does provide a UI slow-down.

diff --git a/libs/hwui/Android.bp b/libs/hwui/Android.bp
index 91e289c..fb9ac1e 100644
--- a/libs/hwui/Android.bp
+++ b/libs/hwui/Android.bp
@@ -28,6 +28,8 @@
         // TODO: Linear blending should be enabled by default, but we are
         // TODO: making it an opt-in while it's a work in progress
         //"-DANDROID_ENABLE_LINEAR_BLENDING",
+
+        "-DREQUIRES_SYNCHRONOUS_SETSURFACE",
     ],
 
     include_dirs: [
diff --git a/libs/hwui/renderthread/RenderProxy.cpp b/libs/hwui/renderthread/RenderProxy.cpp
index 30f0073..939c0c7 100644
--- a/libs/hwui/renderthread/RenderProxy.cpp
+++ b/libs/hwui/renderthread/RenderProxy.cpp
@@ -150,7 +150,11 @@
     SETUP_TASK(initialize);
     args->context = mContext;
     args->surface = surface.get();
+#ifdef REQUIRES_SYNCHRONOUS_SETSURFACE
+    postAndWait(task);
+#else
     post(task);
+#endif
 }
 
 CREATE_BRIDGE2(updateSurface, CanvasContext* context, Surface* surface) {
