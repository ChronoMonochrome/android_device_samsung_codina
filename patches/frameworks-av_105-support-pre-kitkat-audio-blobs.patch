Subject: [PATCH] av: squashed support for pre-kitkat audio blobs
   pre kitkat audio legacy policy fix for hotword (ok google)
   pre-kitkat audio policy blobs re-activated.

    libnbaio: Don't call get_presentation_position for pre KitKat blobs
    This fixes a crash with the HTC Tegra3 audio blob where
    mStream->get_presentation_position is not NULL but pointing to a unknown
    position in memory.

diff --git a/media/libnbaio/include/media/nbaio/AudioStreamOutSink.h b/media/libnbaio/include/media/nbaio/AudioStreamOutSink.h
index 9949b88..b78c4e4 100644
--- a/media/libnbaio/include/media/nbaio/AudioStreamOutSink.h
+++ b/media/libnbaio/include/media/nbaio/AudioStreamOutSink.h
@@ -48,7 +48,9 @@
 
     virtual ssize_t write(const void *buffer, size_t count);
 
+#ifndef HAVE_PRE_KITKAT_AUDIO_BLOB
     virtual status_t getTimestamp(ExtendedTimestamp &timestamp);
+#endif
 
     // NBAIO_Sink end
 
diff --git a/media/libnbaio/Android.bp b/media/libnbaio/Android.bp
index 1353f28..43030d9 100644
--- a/media/libnbaio/Android.bp
+++ b/media/libnbaio/Android.bp
@@ -67,6 +67,7 @@
     cflags: [
         "-Werror",
         "-Wall",
+        "-DHAVE_PRE_KITKAT_AUDIO_BLOB",
     ],
 
     include_dirs: ["system/media/audio_utils/include"],
diff --git a/media/libnbaio/AudioStreamOutSink.cpp b/media/libnbaio/AudioStreamOutSink.cpp
index 0d5f935..dc54887 100644
--- a/media/libnbaio/AudioStreamOutSink.cpp
+++ b/media/libnbaio/AudioStreamOutSink.cpp
@@ -75,6 +75,7 @@
     }
 }
 
+#ifndef HAVE_PRE_KITKAT_AUDIO_BLOB
 status_t AudioStreamOutSink::getTimestamp(ExtendedTimestamp &timestamp)
 {
     uint64_t position64;
@@ -86,5 +87,6 @@
     timestamp.mTimeNs[ExtendedTimestamp::LOCATION_KERNEL] = audio_utils_ns_from_timespec(&time);
     return OK;
 }
+#endif
 
 }   // namespace android
