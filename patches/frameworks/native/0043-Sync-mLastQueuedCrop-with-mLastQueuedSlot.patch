From 96ba71ddfdcf5041df7947a17f3b04cbf57cb9b2 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 43/44] Sync mLastQueuedCrop with mLastQueuedSlot.

Because mLastQueuedCrop is not sync with mLastQueuedSlot at the
same mutex scope, it will cause getLastQueuedBuffer to compute
wrong transform matrix for output graphic buffer.
---
 libs/gui/BufferQueueProducer.cpp | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/libs/gui/BufferQueueProducer.cpp b/libs/gui/BufferQueueProducer.cpp
index d59064785..4f56880be 100644
--- a/libs/gui/BufferQueueProducer.cpp
+++ b/libs/gui/BufferQueueProducer.cpp
@@ -937,7 +937,6 @@ status_t BufferQueueProducer::queueBuffer(int slot,
 
         mCore->mBufferHasBeenQueued = true;
         mCore->mDequeueCondition.broadcast();
-        mCore->mLastQueuedSlot = slot;
 
         output->width = mCore->mDefaultWidth;
         output->height = mCore->mDefaultHeight;
@@ -986,9 +985,13 @@ status_t BufferQueueProducer::queueBuffer(int slot,
         connectedApi = mCore->mConnectedApi;
         lastQueuedFence = std::move(mLastQueueBufferFence);
 
-        mLastQueueBufferFence = std::move(acquireFence);
-        mLastQueuedCrop = item.mCrop;
-        mLastQueuedTransform = item.mTransform;
+        { // Autolock scope
+            Mutex::Autolock lock2(mCore->mMutex);
+            mLastQueueBufferFence = std::move(acquireFence);
+            mLastQueuedCrop = item.mCrop;
+            mLastQueuedTransform = item.mTransform;
+            mCore->mLastQueuedSlot = slot;
+        }
 
         ++mCurrentCallbackTicket;
         mCallbackCondition.broadcast();
-- 
2.11.0

