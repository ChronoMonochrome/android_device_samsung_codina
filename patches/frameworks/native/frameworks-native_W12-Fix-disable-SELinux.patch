From 00a51498866549c67e421ec8a23cda38f556813e Mon Sep 17 00:00:00 2001
From: Sam Doran <git@samdoran.com>
Date: Fri, 4 Mar 2016 01:38:22 -0500
Subject: [PATCH] Fix installd: disable SELinux

diff --git a/cmds/installd/Android.bp b/cmds/installd/Android.bp
index 5e72794..d4f47b0 100644
--- a/cmds/installd/Android.bp
+++ b/cmds/installd/Android.bp
@@ -3,7 +3,6 @@ cc_defaults {
 
     cflags: [
         "-Wall",
-        "-Werror",
     ],
     srcs: [
         "CacheItem.cpp",
diff --git a/cmds/installd/InstalldNativeService.cpp b/cmds/installd/InstalldNativeService.cpp
index 5e72794..d4f47b1 100644
--- a/cmds/installd/InstalldNativeService.cpp
+++ b/cmds/installd/InstalldNativeService.cpp
@@ -239,53 +239,12 @@ status_t InstalldNativeService::dump(int fd, const Vector<String16> & /* args */
  */
 static int restorecon_app_data_lazy(const std::string& path, const std::string& seInfo, uid_t uid,
         bool existing) {
-    int res = 0;
-    char* before = nullptr;
-    char* after = nullptr;
-
-    // Note that SELINUX_ANDROID_RESTORECON_DATADATA flag is set by
-    // libselinux. Not needed here.
-
-    if (lgetfilecon(path.c_str(), &before) < 0) {
-        PLOG(ERROR) << "Failed before getfilecon for " << path;
-        goto fail;
-    }
-    if (selinux_android_restorecon_pkgdir(path.c_str(), seInfo.c_str(), uid, 0) < 0) {
-        PLOG(ERROR) << "Failed top-level restorecon for " << path;
-        goto fail;
-    }
-    if (lgetfilecon(path.c_str(), &after) < 0) {
-        PLOG(ERROR) << "Failed after getfilecon for " << path;
-        goto fail;
-    }
-
-    // If the initial top-level restorecon above changed the label, then go
-    // back and restorecon everything recursively
-    if (strcmp(before, after)) {
-        if (existing) {
-            LOG(DEBUG) << "Detected label change from " << before << " to " << after << " at "
-                    << path << "; running recursive restorecon";
-        }
-        if (selinux_android_restorecon_pkgdir(path.c_str(), seInfo.c_str(), uid,
-                SELINUX_ANDROID_RESTORECON_RECURSE) < 0) {
-            PLOG(ERROR) << "Failed recursive restorecon for " << path;
-            goto fail;
-        }
-    }
-
-    goto done;
-fail:
-    res = -1;
-done:
-    free(before);
-    free(after);
-    return res;
+    return 0;
 }
 
 static int restorecon_app_data_lazy(const std::string& parent, const char* name,
         const std::string& seInfo, uid_t uid, bool existing) {
-    return restorecon_app_data_lazy(StringPrintf("%s/%s", parent.c_str(), name), seInfo, uid,
-            existing);
+    return 0;
 }
 
 static int prepare_app_dir(const std::string& path, mode_t target_mode, uid_t uid) {
