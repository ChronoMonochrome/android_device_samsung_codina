From a0943bd277ed9b5ecaf1c7c1ace7590b1b6da37d Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH] Sync mLastQueuedCrop with mLastQueuedSlot.

Because mLastQueuedCrop is not sync with mLastQueuedSlot at the
same mutex scope, it will cause getLastQueuedBuffer to compute
wrong transform matrix for output graphic buffer.

diff --git a/libs/gui/BufferQueueProducer.cpp b/libs/gui/BufferQueueProducer.cpp
index c5cab2d..3385fab 100644
--- a/libs/gui/BufferQueueProducer.cpp
+++ b/libs/gui/BufferQueueProducer.cpp
@@ -937,7 +937,6 @@
 
         mCore->mBufferHasBeenQueued = true;
         mCore->mDequeueCondition.broadcast();
-        mCore->mLastQueuedSlot = slot;
 
         output->width = mCore->mDefaultWidth;
         output->height = mCore->mDefaultHeight;
@@ -986,9 +985,13 @@
         connectedApi = mCore->mConnectedApi;
         lastQueuedFence = std::move(mLastQueueBufferFence);
 
-        mLastQueueBufferFence = std::move(acquireFence);
-        mLastQueuedCrop = item.mCrop;
-        mLastQueuedTransform = item.mTransform;
+        { // Autolock scope
+            Mutex::Autolock lock2(mCore->mMutex);
+            mLastQueueBufferFence = std::move(acquireFence);
+            mLastQueuedCrop = item.mCrop;
+            mLastQueuedTransform = item.mTransform;
+            mCore->mLastQueuedSlot = slot;
+        }
 
         ++mCurrentCallbackTicket;
         mCallbackCondition.broadcast();
