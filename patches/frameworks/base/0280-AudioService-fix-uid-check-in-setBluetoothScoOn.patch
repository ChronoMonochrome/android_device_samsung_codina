From 41320d25b730267c92950928f97ada1aaca5d42f Mon Sep 17 00:00:00 2001
From: Vitor Albuquerque <vitoralb@motorola.com>
Date: Wed, 7 Mar 2018 10:39:59 -0300
Subject: [PATCH 280/296] AudioService: fix uid check in setBluetoothScoOn

Calling UID is now checked in setBluetoothScoOn and only allow
route to change if request comes from a system component.

The check was not taking into account secondary users, hence
causing failure to route audio to SCO when secondary users
were active.

This change makes sure we are checking the correct app id,
without taking into account the user id.
---
 services/core/java/com/android/server/audio/AudioService.java | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/services/core/java/com/android/server/audio/AudioService.java b/services/core/java/com/android/server/audio/AudioService.java
index d73a1f329d1..4d59f66cca9 100644
--- a/services/core/java/com/android/server/audio/AudioService.java
+++ b/services/core/java/com/android/server/audio/AudioService.java
@@ -2959,7 +2959,7 @@ public class AudioService extends IAudioService.Stub
         }
 
         // Only enable calls from system components
-        if (Binder.getCallingUid() >= FIRST_APPLICATION_UID) {
+        if (UserHandle.getCallingAppId() >= FIRST_APPLICATION_UID) {
             mForcedUseForCommExt = on ? AudioSystem.FORCE_BT_SCO : AudioSystem.FORCE_NONE;
             return;
         }
-- 
2.11.0

