From 3dedb77d102799f859a3bd419e7edf6591a1e440 Mon Sep 17 00:00:00 2001
From: Jun Wang <junwan@codeaurora.org>
Date: Wed, 17 Jan 2018 17:54:43 +0800
Subject: [PATCH] Optimize AbsListView to reduce click operation latency

Separate performClick from delayed message. Then we can do
performClick in advance of PRESSED_STATE_DURATION(64ms) delay.
This will benefit for click operation latency. The delayed
message is still used to clear pressed status.

diff --git a/core/java/android/widget/AbsListView.java b/core/java/android/widget/AbsListView.java
index a733b44ddba..d9921388d8e 100644
--- a/core/java/android/widget/AbsListView.java
+++ b/core/java/android/widget/AbsListView.java
@@ -4030,6 +4030,11 @@ private void onTouchUp(MotionEvent ev) {
                                 }
                                 mSelector.setHotspot(x, ev.getY());
                             }
+                            if (!mDataChanged && !mIsDetaching && isAttachedToWindow()) {
+                                if (!post(performClick)) {
+                                    performClick.run();
+                                }
+                            }
                             if (mTouchModeReset != null) {
                                 removeCallbacks(mTouchModeReset);
                             }
@@ -4040,9 +4045,6 @@ public void run() {
                                     mTouchMode = TOUCH_MODE_REST;
                                     child.setPressed(false);
                                     setPressed(false);
-                                    if (!mDataChanged && !mIsDetaching && isAttachedToWindow()) {
-                                        performClick.run();
-                                    }
                                 }
                             };
                             postDelayed(mTouchModeReset,
