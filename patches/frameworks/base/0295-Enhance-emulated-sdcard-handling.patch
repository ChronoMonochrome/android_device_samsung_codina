From 029c9e71ab92d724383621d319f6c895d0f2029a Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Sat, 25 Aug 2018 18:13:40 +0300
Subject: [PATCH 295/296] Enhance emulated sdcard handling

Change-Id: Ic88df14d56d34fbac086c670424473ff1ca8f4a3
---
 core/java/android/os/storage/StorageManager.java            |  2 ++
 .../core/java/com/android/server/StorageManagerService.java | 13 ++++++++++++-
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/core/java/android/os/storage/StorageManager.java b/core/java/android/os/storage/StorageManager.java
index c23fd04366e..6f7e8e74f0d 100644
--- a/core/java/android/os/storage/StorageManager.java
+++ b/core/java/android/os/storage/StorageManager.java
@@ -109,6 +109,8 @@ public class StorageManager {
     /** {@hide} */
     public static final String PROP_PRIMARY_PHYSICAL = "ro.vold.primary_physical";
     /** {@hide} */
+    public static final String PROP_PRIMARY_EMULATED = "ro.vold.primary_emulated";
+    /** {@hide} */
     public static final String PROP_HAS_ADOPTABLE = "vold.has_adoptable";
     /** {@hide} */
     public static final String PROP_FORCE_ADOPTABLE = "persist.fw.force_adoptable";
diff --git a/services/core/java/com/android/server/StorageManagerService.java b/services/core/java/com/android/server/StorageManagerService.java
index 902302c6d3e..a29fe87f6ac 100644
--- a/services/core/java/com/android/server/StorageManagerService.java
+++ b/services/core/java/com/android/server/StorageManagerService.java
@@ -1303,14 +1303,24 @@ class StorageManagerService extends IStorageManager.Stub
                 vol.mountFlags |= VolumeInfo.MOUNT_FLAG_PRIMARY;
                 vol.mountFlags |= VolumeInfo.MOUNT_FLAG_VISIBLE;
                 mHandler.obtainMessage(H_VOLUME_MOUNT, vol).sendToTarget();
+                return;
 
             } else if (Objects.equals(privateVol.fsUuid, mPrimaryStorageUuid)) {
                 Slog.v(TAG, "Found primary storage at " + vol);
                 vol.mountFlags |= VolumeInfo.MOUNT_FLAG_PRIMARY;
                 vol.mountFlags |= VolumeInfo.MOUNT_FLAG_VISIBLE;
                 mHandler.obtainMessage(H_VOLUME_MOUNT, vol).sendToTarget();
+                return;
             }
 
+            Slog.e(TAG, "emulated volume is not primary vol=" + vol);
+            if (SystemProperties.getBoolean(
+                    "ro.vold.primary_emulated", false))
+               vol.mountFlags |= VolumeInfo.MOUNT_FLAG_PRIMARY;
+            vol.mountFlags |= VolumeInfo.MOUNT_FLAG_VISIBLE;
+            mHandler.obtainMessage(H_VOLUME_MOUNT, vol).sendToTarget();
+
+
         } else if (vol.type == VolumeInfo.TYPE_PUBLIC) {
             // TODO: only look at first public partition
             if (Objects.equals(StorageManager.UUID_PRIMARY_PHYSICAL, mPrimaryStorageUuid)
@@ -1330,10 +1340,11 @@ class StorageManagerService extends IStorageManager.Stub
             mHandler.obtainMessage(H_VOLUME_MOUNT, vol).sendToTarget();
 
         } else if (vol.type == VolumeInfo.TYPE_PRIVATE) {
+            Slog.e(TAG, "onVolumeCreatedLocked: vol.type == VolumeInfo.TYPE_PRIVATE vol=" + vol);
             mHandler.obtainMessage(H_VOLUME_MOUNT, vol).sendToTarget();
 
         } else {
-            Slog.d(TAG, "Skipping automatic mounting of " + vol);
+            Slog.e(TAG, "Skipping automatic mounting of " + vol);
         }
     }
 
-- 
2.11.0

