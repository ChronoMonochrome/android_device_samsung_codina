From e645085f5b50a94b63146c9479d7cf024de3d86a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E7=BB=B4=E6=9C=AF?= <weishu.tws@alipay.com>
Date: Mon, 15 Jan 2018 16:30:02 +0800
Subject: [PATCH 253/296] Fix Bad activity token

 ActivityManager: Bad activity token: android.os.BinderProxy@9fa357
 ActivityManager: java.lang.ClassCastException: android.os.BinderProxy cannot be cast to com.android.server.am.ActivityRecord$Token
 ActivityManager: 	at com.android.server.am.ActivityRecord.forTokenLocked(ActivityRecord.java:597)
 ActivityManager: 	at com.android.server.am.ActivityRecord.isInStackLocked(ActivityRecord.java:1373)
---
 services/core/java/com/android/server/am/ActivityRecord.java | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/services/core/java/com/android/server/am/ActivityRecord.java b/services/core/java/com/android/server/am/ActivityRecord.java
index 9723dc8442d..78d0a17e8e9 100644
--- a/services/core/java/com/android/server/am/ActivityRecord.java
+++ b/services/core/java/com/android/server/am/ActivityRecord.java
@@ -779,6 +779,9 @@ final class ActivityRecord extends ConfigurationContainer implements AppWindowCo
     }
 
     static ActivityRecord forTokenLocked(IBinder token) {
+        if (token == null) {
+            return null;
+        }
         try {
             return Token.tokenToActivityRecordLocked((Token)token);
         } catch (ClassCastException e) {
-- 
2.11.0

