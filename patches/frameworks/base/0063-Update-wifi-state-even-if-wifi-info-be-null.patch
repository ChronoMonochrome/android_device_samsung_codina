From 9e085e5ec8f3ddeafacb022c29d049ba1ab68ddf Mon Sep 17 00:00:00 2001
From: Nalla Kartheek <karthe@codeaurora.org>
Date: Tue, 8 Dec 2015 15:18:26 +0530
Subject: [PATCH 063/296] Update wifi state even if wifi info be null

So once no get_link_stats implementation in wifi_hal,
it will cause the codes return null.
However, wifi_get_link_stats is not necessary to implement.
We update the wifi info even if wifi info be null,
when wifi_get_link_stats not support.
---
 .../java/com/android/server/am/BatteryExternalStatsWorker.java | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/services/core/java/com/android/server/am/BatteryExternalStatsWorker.java b/services/core/java/com/android/server/am/BatteryExternalStatsWorker.java
index 8af1f3eae0d..4472f5993a1 100644
--- a/services/core/java/com/android/server/am/BatteryExternalStatsWorker.java
+++ b/services/core/java/com/android/server/am/BatteryExternalStatsWorker.java
@@ -21,6 +21,7 @@ import android.bluetooth.BluetoothAdapter;
 import android.content.Context;
 import android.net.wifi.IWifiManager;
 import android.net.wifi.WifiActivityEnergyInfo;
+import android.net.wifi.WifiManager;
 import android.os.BatteryStats;
 import android.os.Parcelable;
 import android.os.RemoteException;
@@ -74,6 +75,8 @@ class BatteryExternalStatsWorker implements BatteryStatsImpl.ExternalStatsSync {
     private final Context mContext;
     private final BatteryStatsImpl mStats;
 
+    private WifiManager mWifi;
+
     @GuardedBy("this")
     private int mUpdateFlags = 0;
 
@@ -209,6 +212,7 @@ class BatteryExternalStatsWorker implements BatteryStatsImpl.ExternalStatsSync {
         SynchronousResultReceiver bluetoothReceiver = null;
         SynchronousResultReceiver modemReceiver = null;
 
+        Slog.e(TAG, "updateExternalStatsLocked reason:" + reason + " flag:" + updateFlags);
         if ((updateFlags & BatteryStatsImpl.ExternalStatsSync.UPDATE_WIFI) != 0) {
             // We were asked to fetch WiFi data.
             if (mWifiManager == null) {
@@ -286,6 +290,12 @@ class BatteryExternalStatsWorker implements BatteryStatsImpl.ExternalStatsSync {
             } else {
                 Slog.e(TAG, "wifi info is invalid: " + wifiInfo);
             }
+        } else {
+                mWifi = (WifiManager) mContext.getSystemService(mContext.WIFI_SERVICE);
+                if (mWifi != null && !mWifi.isEnhancedPowerReportingSupported()) {
+                    mStats.updateWifiState(null);
+                }
+                Slog.e(TAG, "wifi info is null ");
         }
 
         if (modemInfo != null) {
-- 
2.11.0

