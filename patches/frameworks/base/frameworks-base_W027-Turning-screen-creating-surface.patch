From 93b9a6d8ae9e4a07ee3cd4da2c2fc60a5212a6da Mon Sep 17 00:00:00 2001
From: Tetsutoki Shiozawa <tetsutoki.shiozawa@sony.com>
Date: Wed, 25 Oct 2017 19:17:47 +0900
Subject: [PATCH] Turning screen on without creating surface

Symptopm:
The screen doesn't wake up when it gets a second in-coming call.

Solution:
If the surface is already visible, TurnOnScreen flag is not
evaluated. We should directly request turning screen on to
the manager. This is the last resort to wakeup screen.

diff --git a/services/core/java/com/android/server/wm/WindowState.java b/services/core/java/com/android/server/wm/WindowState.java
index 96582fc..605bd5e 100644
--- a/services/core/java/com/android/server/wm/WindowState.java
+++ b/services/core/java/com/android/server/wm/WindowState.java
@@ -2315,8 +2315,12 @@
 
         // If we were already visible, skip rest of preparation.
         if (wasVisible) {
-            if (DEBUG_VISIBILITY) Slog.v(TAG,
-                    "Already visible and does not turn on screen, skip preparing: " + this);
+            if (DEBUG_VISIBILITY) Slog.v(TAG, "Already visible, skip preparing: " + this);
+            if (mTurnOnScreen) {
+                // If the surface is already visible, TurnOnScreen flag is not evaluated.
+                // We should directly request turning screen on to the manager.
+                mService.mTurnOnScreen = true;
+            }
             return;
         }
 
