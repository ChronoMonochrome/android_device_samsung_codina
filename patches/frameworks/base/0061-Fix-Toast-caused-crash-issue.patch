From a60e003952f4094d4ad1c3583e6530c5ca1889fb Mon Sep 17 00:00:00 2001
From: zhangji <zhangji@smartisan.com>
Date: Thu, 15 Dec 2016 15:09:32 +0800
Subject: [PATCH 061/296] Fix Toast-caused crash issue

Imagine we try to add Toasts for an app, when app goes to background,
only one Toast is permitted for the logic in WindowManager, the 2nd
Toast will cause BadTokenException, when we add the 2nd Toast again,
crash will occur.

We should not ignore this BadTokenException, call removeView when
addView is not successfully executed.
---
 core/java/android/widget/Toast.java | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/core/java/android/widget/Toast.java b/core/java/android/widget/Toast.java
index d80712006a5..5addaa9b420 100644
--- a/core/java/android/widget/Toast.java
+++ b/core/java/android/widget/Toast.java
@@ -496,7 +496,10 @@ public class Toast {
                     mWM.addView(mView, mParams);
                     trySendAccessibilityEvent();
                 } catch (WindowManager.BadTokenException e) {
-                    /* ignore */
+                    // Remove mView here to cleanup from an exception
+                    // and protect future calls to handleShow
+                    e.printStackTrace();
+                    mWM.removeViewImmediate(mView);
                 }
             }
         }
-- 
2.11.0

