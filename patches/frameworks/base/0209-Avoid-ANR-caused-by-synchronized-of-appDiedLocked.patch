From c33ecb691284abea89a7008987e9213401f6f626 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 209/296] Avoid ANR caused by synchronized() of appDiedLocked()

Symptom:
SystemUI is crashed by ANR.

Root cause:
 1) The application is crashed.
 2) ActivityManagerService handles it using AppDeathRecipient.
 3) AppDeathRecipient calls synchronized() for a long time.
 4) SystemUI calls the method locked by synchronized on Main thread.
 5) Main thread is blocked. and SystemUI is crashed by ANR.

Solution:
updateOomAdjLocked() is moved to Handler thread
from ActivityManagerService#appDiedLocked().
---
 .../java/com/android/server/am/ActivityManagerService.java     | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/services/core/java/com/android/server/am/ActivityManagerService.java b/services/core/java/com/android/server/am/ActivityManagerService.java
index 031297e04f3..b728d896292 100644
--- a/services/core/java/com/android/server/am/ActivityManagerService.java
+++ b/services/core/java/com/android/server/am/ActivityManagerService.java
@@ -1703,6 +1703,8 @@ public class ActivityManagerService extends IActivityManager.Stub
     static ServiceThread sKillThread = null;
     static KillHandler sKillHandler = null;
 
+    static final int UPDATE_OOMADJ_MSG = 99999;
+
     CompatModeDialog mCompatModeDialog;
     UnsupportedDisplaySizeDialog mUnsupportedDisplaySizeDialog;
     long mLastMemUsageReportTime = 0;
@@ -2508,6 +2510,11 @@ public class ActivityManagerService extends IActivityManager.Stub
                     }
                 }
             } break;
+            case UPDATE_OOMADJ_MSG: {
+                synchronized (ActivityManagerService.this) {
+                    updateOomAdjLocked();
+                }
+            } break;
             }
         }
     };
@@ -5540,7 +5547,8 @@ public class ActivityManagerService extends IActivityManager.Stub
             handleAppDiedLocked(app, false, true);
 
             if (doOomAdj) {
-                updateOomAdjLocked();
+                mHandler.removeMessages(UPDATE_OOMADJ_MSG);
+                mHandler.sendEmptyMessage(UPDATE_OOMADJ_MSG);
             }
             if (doLowMem) {
                 doLowMemReportIfNeededLocked(app);
-- 
2.11.0

