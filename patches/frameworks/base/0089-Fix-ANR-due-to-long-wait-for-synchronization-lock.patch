From e4af3be2eb6c6283f887dd62f6fc86b84db84a75 Mon Sep 17 00:00:00 2001
From: Gurpreet Ghai <gghai@codeaurora.org>
Date: Wed, 10 Aug 2016 15:14:40 +0530
Subject: [PATCH 089/296] Fix ANR due to long wait for synchronization lock

Use Case: Repeated BT ON/OFF

Failure: ANR occurs due to UI wait for long time waiting
to acquire thread lock.

Steps: Repeated BT ON/OFF

Root Cause: The synchronized function that updates state
also read paired devices as an additional operation. When
the number of devices is cached list is large, the block
time for other threads waiting for same lock tends to
increase causing ANR.

Fix: Limited the synchronized block to the part where
actual update of local state takes place.
---
 .../com/android/settingslib/bluetooth/LocalBluetoothAdapter.java | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)
 mode change 100755 => 100644 packages/SettingsLib/src/com/android/settingslib/bluetooth/LocalBluetoothAdapter.java

diff --git a/packages/SettingsLib/src/com/android/settingslib/bluetooth/LocalBluetoothAdapter.java b/packages/SettingsLib/src/com/android/settingslib/bluetooth/LocalBluetoothAdapter.java
old mode 100755
new mode 100644
index 22674cb6de9..ebe794c02cf
--- a/packages/SettingsLib/src/com/android/settingslib/bluetooth/LocalBluetoothAdapter.java
+++ b/packages/SettingsLib/src/com/android/settingslib/bluetooth/LocalBluetoothAdapter.java
@@ -194,8 +194,13 @@ public class LocalBluetoothAdapter {
         return mState;
     }
 
-    synchronized void setBluetoothStateInt(int state) {
-        mState = state;
+    void setBluetoothStateInt(int state) {
+        synchronized(this) {
+            if (mState == state) {
+                return;
+            }
+            mState = state;
+        }
 
         if (state == BluetoothAdapter.STATE_ON) {
             // if mProfileManager hasn't been constructed yet, it will
-- 
2.11.0

