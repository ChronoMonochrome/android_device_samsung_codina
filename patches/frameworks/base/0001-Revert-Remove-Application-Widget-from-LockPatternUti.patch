From 9eab7cbf07a7f06b7d92c871b9f8d76aee7253be Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 25 Jan 2016 01:01:54 +0700
Subject: [PATCH 01/64] Revert "Remove Application Widget from
 LockPatternUtils"

This reverts commit 6f6b03f887aeb492a55ab57944e81cb2e92fa1c6.
---
 .../com/android/internal/widget/LockPatternUtils.java  | 18 ++++++++++++++++++
 .../src/com/android/keyguard/KeyguardHostView.java     |  3 ++-
 .../systemui/statusbar/phone/NavigationBarView.java    |  2 +-
 3 files changed, 21 insertions(+), 2 deletions(-)

diff --git a/core/java/com/android/internal/widget/LockPatternUtils.java b/core/java/com/android/internal/widget/LockPatternUtils.java
index ca15551..98efda0 100644
--- a/core/java/com/android/internal/widget/LockPatternUtils.java
+++ b/core/java/com/android/internal/widget/LockPatternUtils.java
@@ -157,6 +157,8 @@ public class LockPatternUtils {
     public final static String LOCKSCREEN_POWER_BUTTON_INSTANTLY_LOCKS
             = "lockscreen.power_button_instantly_locks";
     public final static String LOCKSCREEN_WIDGETS_ENABLED = "lockscreen.widgets_enabled";
+    public final static String LOCKSCREEN_APPLICATION_WIDGET_ENABLED =
+            "lockscreen.application_widget_enabled";
     public final static String LOCKSCREEN_CAMERA_ENABLED = "lockscreen.camera_enabled";
 
     public final static String PASSWORD_HISTORY_KEY = "lockscreen.passwordhistory";
@@ -1583,6 +1585,22 @@ public class LockPatternUtils {
         setBoolean(LOCKSCREEN_WIDGETS_ENABLED, enabled, userId);
     }
 
+    public boolean getApplicationWidgetEnabled() {
+        return getApplicationWidgetEnabled(getCurrentOrCallingUserId());
+    }
+
+    public boolean getApplicationWidgetEnabled(int userId) {
+        return getBoolean(LOCKSCREEN_APPLICATION_WIDGET_ENABLED, true, userId);
+    }
+
+    public void setApplicationWidgetEnabled(boolean enabled) {
+        setApplicationWidgetEnabled(enabled, getCurrentOrCallingUserId());
+    }
+
+    public void setApplicationWidgetEnabled(boolean enabled, int userId) {
+        setBoolean(LOCKSCREEN_APPLICATION_WIDGET_ENABLED, enabled, userId);
+    }
+
     public boolean getCameraEnabled() {
         return getCameraEnabled(getCurrentOrCallingUserId());
     }
diff --git a/packages/Keyguard/src/com/android/keyguard/KeyguardHostView.java b/packages/Keyguard/src/com/android/keyguard/KeyguardHostView.java
index 1f30e72..4e3576f 100644
--- a/packages/Keyguard/src/com/android/keyguard/KeyguardHostView.java
+++ b/packages/Keyguard/src/com/android/keyguard/KeyguardHostView.java
@@ -558,7 +558,8 @@ public class KeyguardHostView extends KeyguardViewBase {
     private boolean applicationWidgetDisabledByDpm() {
         boolean disabledByDpm =
                 (mDisabledFeatures & DevicePolicyManager.KEYGUARD_DISABLE_APPLICATION_WIDGET) != 0;
-        return disabledByDpm;
+        boolean disabledByUser = !mLockPatternUtils.getApplicationWidgetEnabled();
+        return disabledByDpm || disabledByUser;
     }
 
     private void updateSecurityViews() {
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationBarView.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationBarView.java
index 69107a3..8d1dee3 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationBarView.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationBarView.java
@@ -644,7 +644,7 @@ public class NavigationBarView extends LinearLayout {
         final boolean showNotifs = disableHome && !disableSearch && mPrefLockscreen;
         // TODO(): Ideally we should integrate with DevicePolicyManager for application widget too.
         final boolean showApplicationWidget = showSearch &&
-                mApplicationWidgetPackageName != null;
+                mApplicationWidgetPackageName != null && mLockPatternUtils.getApplicationWidgetEnabled();
 
         setVisibleOrGone(getSearchLight(), showSearch);
         setVisibleOrGone(getCameraButton(), showCamera);
-- 
2.5.0

