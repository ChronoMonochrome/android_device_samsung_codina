From 2cdb71822206b11e9e2ed49cefeb041d4c15680a Mon Sep 17 00:00:00 2001
From: Tetsutoki Shiozawa <tetsutoki.x.shiozawa@sonymobile.com>
Date: Wed, 25 Nov 2015 23:02:36 +0900
Subject: [PATCH 153/296] Store package restriction settings at shutdown

Symptom:
Disabled package was re-enabled by restarting a device.

Root cause:
PMS postpones storing the package restriction settings in 10
seconds by design. When a package gets disabled right before
shutdown, PMS fails to store the last changes.

Solution:
Store package restriction settings at shutdown.
---
 services/core/java/com/android/server/pm/PackageManagerService.java | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/services/core/java/com/android/server/pm/PackageManagerService.java b/services/core/java/com/android/server/pm/PackageManagerService.java
index 8430ea978f5..dc305742791 100644
--- a/services/core/java/com/android/server/pm/PackageManagerService.java
+++ b/services/core/java/com/android/server/pm/PackageManagerService.java
@@ -10294,6 +10294,12 @@ public class PackageManagerService extends IPackageManager.Stub
         mPackageUsage.writeNow(mPackages);
         mCompilerStats.writeNow();
         mDexManager.writePackageDexUsageNow();
+
+        // This is the last chance to write out pending restriction settings.
+        if (mHandler.hasMessages(WRITE_PACKAGE_RESTRICTIONS)) {
+            mHandler.removeMessages(WRITE_PACKAGE_RESTRICTIONS);
+            mHandler.sendEmptyMessage(WRITE_PACKAGE_RESTRICTIONS);
+        }
     }
 
     @Override
-- 
2.11.0

