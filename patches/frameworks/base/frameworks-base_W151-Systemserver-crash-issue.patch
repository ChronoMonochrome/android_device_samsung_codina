From 29293e41c1d84b74ba0c6499262da3ad9195f0d8 Mon Sep 17 00:00:00 2001
From: "zhenjun.zhang" <zhenjun.zhang@spreadtrum.com>
Date: Mon, 5 Feb 2018 10:57:29 +0800
Subject: [PATCH] Systemserver crash issue.

The LegacyGlobalAction's dialog may be create in two thread, since 
view's UI operation can only do in one thread, it may occur systemserver
crash during monkey.

This issue may reproduce when SystemUI is crash or killing when ANR.

Fix: create the dialog useing the handler thread only.

diff --git a/services/core/java/com/android/server/policy/GlobalActions.java b/services/core/java/com/android/server/policy/GlobalActions.java
index 342ec4b..942d049 100644
--- a/services/core/java/com/android/server/policy/GlobalActions.java
+++ b/services/core/java/com/android/server/policy/GlobalActions.java
@@ -90,8 +90,10 @@
         mStatusBarConnected = connected;
         if (mShowing && !mStatusBarConnected) {
             // Status bar died but we need to be showing global actions still, show the legacy.
-            ensureLegacyCreated();
-            mLegacyGlobalActions.showDialog(mKeyguardShowing, mDeviceProvisioned);
+            mHandler.post(() -> {
+                ensureLegacyCreated();
+                mLegacyGlobalActions.showDialog(mKeyguardShowing, mDeviceProvisioned);
+            });
         }
     }
 
