From 2ed385a78831ca04adf781559f0eb255ed9f53fe Mon Sep 17 00:00:00 2001
From: Amit Pundir <amit.pundir@linaro.org>
Date: Sat, 27 Jul 2013 01:44:32 +0530
Subject: [PATCH 167/296] frameworks/base: Fix AudioService JNI leaks

Root cause: AudioService keeps creating new instance of
ForceControlStreamClient and linkToDeath with the same
callback which leads to global reference table overflow
Fix: don't create new instance if call back doesn't change;
release old instance before create new one
---
 .../core/java/com/android/server/audio/AudioService.java  | 15 ++++++++++++++-
 1 file changed, 14 insertions(+), 1 deletion(-)

diff --git a/services/core/java/com/android/server/audio/AudioService.java b/services/core/java/com/android/server/audio/AudioService.java
index 570faf4a9a8..eae9c4eccee 100644
--- a/services/core/java/com/android/server/audio/AudioService.java
+++ b/services/core/java/com/android/server/audio/AudioService.java
@@ -1874,7 +1874,16 @@ public class AudioService extends IAudioService.Stub
                 }
                 mUserSelectedVolumeControlStream = false;
             } else {
-                mForceControlStreamClient = new ForceControlStreamClient(cb);
+                if (null == mForceControlStreamClient) {
+                    mForceControlStreamClient = new ForceControlStreamClient(cb);
+                } else {
+                    if (mForceControlStreamClient.getBinder() == cb) {
+                        Log.d(TAG, "forceVolumeControlStream cb:" + cb + " is already linked.");
+                    } else {
+                        mForceControlStreamClient.release();
+                        mForceControlStreamClient = new ForceControlStreamClient(cb);
+                    }
+                }
             }
         }
     }
@@ -1914,6 +1923,10 @@ public class AudioService extends IAudioService.Stub
                 mCb = null;
             }
         }
+
+        public IBinder getBinder() {
+            return mCb;
+        }
     }
 
     private void sendBroadcastToAll(Intent intent) {
-- 
2.11.0

