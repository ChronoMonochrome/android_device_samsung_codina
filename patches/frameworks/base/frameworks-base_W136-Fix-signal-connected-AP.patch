From a0943bd277ed9b5ecaf1c7c1ace7590b1b6da37d Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH] Wifi: Fix the signal weak when forget the connected AP.

 1. Sync with wifi settings' UNREACHABLE_RSSI with wifi framework's invalid value
 2. Fix the condition of updating AP's info in AccessPoint.java. When
Wifi configuration is null and it is not ephemeral, we should not update rssi from wifi info.

diff --git a/packages/SettingsLib/src/com/android/settingslib/wifi/AccessPoint.java b/packages/SettingsLib/src/com/android/settingslib/wifi/AccessPoint.java
old mode 100644
new mode 100755
index 682b85e..11e0126
--- a/packages/SettingsLib/src/com/android/settingslib/wifi/AccessPoint.java
+++ b/packages/SettingsLib/src/com/android/settingslib/wifi/AccessPoint.java
@@ -172,7 +172,7 @@
      */
     public static final int SIGNAL_LEVELS = 5;
 
-    public static final int UNREACHABLE_RSSI = Integer.MIN_VALUE;
+    public static final int UNREACHABLE_RSSI = WifiConfiguration.INVALID_RSSI;
 
     private final Context mContext;
 
@@ -1084,7 +1084,11 @@
             // Might be an ephemeral connection with no WifiConfiguration. Try matching on SSID.
             // (Note that we only do this if the WifiConfiguration explicitly equals INVALID).
             // TODO: Handle hex string SSIDs.
-            return ssid.equals(removeDoubleQuotes(info.getSSID()));
+            if (!info.isEphemeral() && config == null) {
+                return false;
+            } else {
+                return ssid.equals(removeDoubleQuotes(info.getSSID()));
+            }
         }
     }
 
