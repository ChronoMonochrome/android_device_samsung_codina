From bc041e3f07de03474c68f0bcbf057bf9ad9da674 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 015/296] Fixed SystemUI crash when disable GPU acceleration

chooseEglConfig fails when OpenGL-ES 2.0 is not available.
But it supports to switch to software Canvas render if it fails.
If it throws exception, it can't switch to software render.
So, it should return false other than throw exception.
createContext should do the same thing.
---
 packages/SystemUI/src/com/android/systemui/ImageWallpaper.java | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/packages/SystemUI/src/com/android/systemui/ImageWallpaper.java b/packages/SystemUI/src/com/android/systemui/ImageWallpaper.java
index 907a79e723a..8f3f6bf4b5c 100644
--- a/packages/SystemUI/src/com/android/systemui/ImageWallpaper.java
+++ b/packages/SystemUI/src/com/android/systemui/ImageWallpaper.java
@@ -778,13 +778,16 @@ public class ImageWallpaper extends WallpaperService {
 
             mEglConfig = chooseEglConfig();
             if (mEglConfig == null) {
-                throw new RuntimeException("eglConfig not initialized");
+                //chooseEGLConfig fail since no egl render type EGL_OPENGL_ES2_BIT when disable gpu acceleration,
+                //should switch to SW canvas renderer without throwing exception in this case.
+                checkEglError();
+                return false;
             }
 
             mEglContext = createContext(mEgl, mEglDisplay, mEglConfig);
             if (mEglContext == EGL_NO_CONTEXT) {
-                throw new RuntimeException("createContext failed " +
-                        GLUtils.getEGLErrorString(mEgl.eglGetError()));
+                checkEglError();
+                return false;
             }
 
             int attribs[] = {
-- 
2.11.0

