From 3780d8eb8f8bb8d1b9372dccd589b385fae08d9b Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 211/296] Optimize setStorageEncryption code

If the filesystem does not support encryption,
getActiveAdminForCallerLocked is not necessary to be called
---
 .../android/server/devicepolicy/DevicePolicyManagerService.java  | 9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/services/devicepolicy/java/com/android/server/devicepolicy/DevicePolicyManagerService.java b/services/devicepolicy/java/com/android/server/devicepolicy/DevicePolicyManagerService.java
index 5268383ade5..874789f38a0 100644
--- a/services/devicepolicy/java/com/android/server/devicepolicy/DevicePolicyManagerService.java
+++ b/services/devicepolicy/java/com/android/server/devicepolicy/DevicePolicyManagerService.java
@@ -5832,19 +5832,18 @@ public class DevicePolicyManagerService extends IDevicePolicyManager.Stub {
             // Only system user can set storage encryption
             if (userHandle != UserHandle.USER_SYSTEM) {
                 Slog.w(LOG_TAG, "Only owner/system user is allowed to set storage encryption. User "
-                        + UserHandle.getCallingUserId() + " is not permitted.");
-                return 0;
+                        + userHandle + " is not permitted.");
+                return DevicePolicyManager.ENCRYPTION_STATUS_UNSUPPORTED;
             }
 
-            ActiveAdmin ap = getActiveAdminForCallerLocked(who,
-                    DeviceAdminInfo.USES_ENCRYPTED_STORAGE);
-
             // Quick exit:  If the filesystem does not support encryption, we can exit early.
             if (!isEncryptionSupported()) {
                 return DevicePolicyManager.ENCRYPTION_STATUS_UNSUPPORTED;
             }
 
             // (1) Record the value for the admin so it's sticky
+            ActiveAdmin ap = getActiveAdminForCallerLocked(who,
+                    DeviceAdminInfo.USES_ENCRYPTED_STORAGE);
             if (ap.encryptionRequested != encrypt) {
                 ap.encryptionRequested = encrypt;
                 saveSettingsLocked(userHandle);
-- 
2.11.0

