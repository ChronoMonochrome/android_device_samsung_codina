From 3c8b849e9ffa39e3d2e35a09712149858855b75a Mon Sep 17 00:00:00 2001
From: Nalla Kartheek <karthe@codeaurora.org>
Date: Mon, 19 Sep 2016 16:11:48 +0530
Subject: [PATCH 4/5] Wi-Fi : Abort setWifiEnabled if WifiController not ready

While executing setWifiEnabled, it send commands to WifiController.
If WifiController is not started by this time, StateMachine reports
crash which creates device reboot.
Thus, check if WiFiController is started before invoking any
command to the same. Indicate a failure in such an instance.
---
 service/java/com/android/server/wifi/WifiServiceImpl.java | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/service/java/com/android/server/wifi/WifiServiceImpl.java b/service/java/com/android/server/wifi/WifiServiceImpl.java
index a5e5c3d99..5feee8917 100644
--- a/service/java/com/android/server/wifi/WifiServiceImpl.java
+++ b/service/java/com/android/server/wifi/WifiServiceImpl.java
@@ -188,6 +188,7 @@ public class WifiServiceImpl extends IWifiManager.Stub {
     private WifiScanner mWifiScanner;
     private WifiLog mLog;
 
+    private boolean mIsControllerStarted = false;
     /**
      * Asynchronous channel to WifiStateMachine
      */
@@ -555,6 +556,7 @@ public class WifiServiceImpl extends IWifiManager.Stub {
             Log.wtf(TAG, "Failed to initialize WifiStateMachine");
         }
         mWifiController.start();
+        mIsControllerStarted = true;
 
         // If we are already disabled (could be due to airplane mode), avoid changing persist
         // state here
@@ -817,6 +819,10 @@ public class WifiServiceImpl extends IWifiManager.Stub {
             Binder.restoreCallingIdentity(ident);
         }
 
+        if (!mIsControllerStarted) {
+            Slog.e(TAG,"WifiController is not yet started, abort setWifiEnabled");
+            return false;
+        }
 
         if (mPermissionReviewRequired) {
             final int wiFiEnabledState = getWifiEnabledState();
-- 
2.11.0

