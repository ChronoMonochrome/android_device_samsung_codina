From 5a42da1bef15f2614f146906cb3caa8e9f865c60 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 1/4] Fix data gateway

---
 .../telephony/dataconnection/DataCallResponse.java | 24 ++--------------------
 1 file changed, 2 insertions(+), 22 deletions(-)

diff --git a/src/java/com/android/internal/telephony/dataconnection/DataCallResponse.java b/src/java/com/android/internal/telephony/dataconnection/DataCallResponse.java
index bc02b979e..2c578a37e 100644
--- a/src/java/com/android/internal/telephony/dataconnection/DataCallResponse.java
+++ b/src/java/com/android/internal/telephony/dataconnection/DataCallResponse.java
@@ -183,6 +183,8 @@ public class DataCallResponse {
                             }
 
                             linkProperties.addLinkAddress(la);
+                            // PPP: Use client ip address as default gateway
+                            linkProperties.addRoute(new RouteInfo(ia));
                         }
                     }
                 } else {
@@ -225,28 +227,6 @@ public class DataCallResponse {
                     throw new UnknownHostException("Empty dns response and no system default dns");
                 }
 
-                // set gateways
-                if ((gateways == null) || (gateways.length == 0)) {
-                    String sysGateways = SystemProperties.get(propertyPrefix + "gw");
-                    if (sysGateways != null) {
-                        gateways = sysGateways.split(" ");
-                    } else {
-                        gateways = new String[0];
-                    }
-                }
-                for (String addr : gateways) {
-                    addr = addr.trim();
-                    if (addr.isEmpty()) continue;
-                    InetAddress ia;
-                    try {
-                        ia = NetworkUtils.numericToInetAddress(addr);
-                    } catch (IllegalArgumentException e) {
-                        throw new UnknownHostException("Non-numeric gateway addr=" + addr);
-                    }
-                    // Allow 0.0.0.0 or :: as a gateway; this indicates a point-to-point interface.
-                    linkProperties.addRoute(new RouteInfo(ia));
-                }
-
                 // set interface MTU
                 // this may clobber the setting read from the APN db, but that's ok
                 linkProperties.setMtu(mtu);
-- 
2.11.0

