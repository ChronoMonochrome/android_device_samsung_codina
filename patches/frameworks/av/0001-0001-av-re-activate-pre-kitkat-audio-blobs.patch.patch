From 13ebfcf276450fd8754162ad9209ee26786fc56b Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Sun, 24 May 2015 22:11:08 +0300
Subject: [PATCH 1/9] 0001-av-re-activate-pre-kitkat-audio-blobs.patch

Change-Id: Ie2b7e2b3a6f77031e28e4f95af09acd5c4b516d0
---
 services/audiopolicy/Android.mk                         |  4 ++++
 services/audiopolicy/AudioPolicyClientImplLegacy.cpp    | 10 ++++++++--
 services/audiopolicy/AudioPolicyInterfaceImplLegacy.cpp |  3 +++
 3 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/services/audiopolicy/Android.mk b/services/audiopolicy/Android.mk
index 188fc89..56ad566 100644
--- a/services/audiopolicy/Android.mk
+++ b/services/audiopolicy/Android.mk
@@ -38,6 +38,10 @@ LOCAL_SHARED_LIBRARIES += \
     libaudiopolicymanager
 endif
 
+ifeq ($(BOARD_HAVE_PRE_KITKAT_AUDIO_BLOB),true)
+    LOCAL_CFLAGS += -DHAVE_PRE_KITKAT_AUDIO_BLOB
+endif
+
 LOCAL_STATIC_LIBRARIES := \
     libmedia_helper
 
diff --git a/services/audiopolicy/AudioPolicyClientImplLegacy.cpp b/services/audiopolicy/AudioPolicyClientImplLegacy.cpp
index a79f8ae..86f1070 100644
--- a/services/audiopolicy/AudioPolicyClientImplLegacy.cpp
+++ b/services/audiopolicy/AudioPolicyClientImplLegacy.cpp
@@ -125,8 +125,14 @@ audio_io_handle_t aps_open_output_on_module(void *service __unused,
                                                    audio_output_flags_t flags,
                                                    const audio_offload_info_t *offloadInfo)
 {
-    return open_output(module, pDevices, pSamplingRate, pFormat, pChannelMask,
-                          pLatencyMs, flags, offloadInfo);
+#ifdef HAVE_PRE_KITKAT_AUDIO_BLOB
+     return open_output(module, pDevices, pSamplingRate, pFormat, pChannelMask,
+                           pLatencyMs, flags, NULL);
+#else
+     return open_output(module, pDevices, pSamplingRate, pFormat, pChannelMask,
+                           pLatencyMs, flags, offloadInfo);
+#endif
+
 }
 
 audio_io_handle_t aps_open_dup_output(void *service __unused,
diff --git a/services/audiopolicy/AudioPolicyInterfaceImplLegacy.cpp b/services/audiopolicy/AudioPolicyInterfaceImplLegacy.cpp
index b8846c6..344bbe1 100644
--- a/services/audiopolicy/AudioPolicyInterfaceImplLegacy.cpp
+++ b/services/audiopolicy/AudioPolicyInterfaceImplLegacy.cpp
@@ -490,6 +490,9 @@ status_t AudioPolicyService::queryDefaultPreProcessing(int audioSession,
                                                        effect_descriptor_t *descriptors,
                                                        uint32_t *count)
 {
+#ifdef HAVE_PRE_KITKAT_AUDIO_BLOB
+    return false;
+#endif
     if (mpAudioPolicy == NULL) {
         *count = 0;
         return NO_INIT;
-- 
1.9.1

