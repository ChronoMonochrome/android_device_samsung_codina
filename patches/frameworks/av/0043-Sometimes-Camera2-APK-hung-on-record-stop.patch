From 8d5f9592c92480567db6d77223de582949d30a70 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 43/57] Sometimes Camera2 APK hung on record stop

Blocked on AudioSource::waitOutstandingEncodingFrames_l().
In MediaCodecSource, when process kWhatStop event, if already met EOS,
should also call mPuller->stop() to return back media buffers.
---
 media/libstagefright/MediaCodecSource.cpp | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/media/libstagefright/MediaCodecSource.cpp b/media/libstagefright/MediaCodecSource.cpp
index ea2b37cf3..97222382e 100644
--- a/media/libstagefright/MediaCodecSource.cpp
+++ b/media/libstagefright/MediaCodecSource.cpp
@@ -999,6 +999,12 @@ void MediaCodecSource::onMessageReceived(const sp<AMessage> &msg) {
             // if we already reached EOS, reply and return now
             ALOGI("encoder (%s) already stopped",
                     mIsVideo ? "video" : "audio");
+
+            // There maybe media buffers in the queue, should return back.
+            // Or the AudioSource will block on waitOutstandingEncodingFrames_l()
+            if (!(mFlags & FLAG_USE_SURFACE_INPUT))
+                mPuller->stop();
+
             (new AMessage)->postReply(replyID);
             break;
         }
-- 
2.11.0

