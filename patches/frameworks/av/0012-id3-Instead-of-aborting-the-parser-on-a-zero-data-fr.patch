From 1052621e4be5c0d0ca45a8bf9e6ee7b8d11493b7 Mon Sep 17 00:00:00 2001
From: Ricardo Cerqueira <ricardo@cyngn.com>
Date: Sun, 13 Sep 2015 23:25:48 +0100
Subject: [PATCH 12/13] id3: Instead of aborting the parser on a zero-data
 frame, just skip that frame

Fixes android.media.cts.MediaScannerTest#testEncodingDetection

Change-Id: I6c17af356791215d678d1e3d4a1f04883fae7537
---
 media/libstagefright/id3/ID3.cpp | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/media/libstagefright/id3/ID3.cpp b/media/libstagefright/id3/ID3.cpp
index 683c6ef..d97a723 100644
--- a/media/libstagefright/id3/ID3.cpp
+++ b/media/libstagefright/id3/ID3.cpp
@@ -683,7 +683,10 @@ void ID3::Iterator::findFrame() {
             }
 
             if (baseSize == 0) {
-                return;
+                /* Don't try to parse a frame with zero-sized data. Skip this
+                 * header entirely */
+                mOffset += 10; // http://id3.org/id3v2.4.0-structure section 3.1
+                continue;
             }
 
             // Prevent integer overflow when adding
-- 
2.5.0

