From c21ab680161647781248e194784686879ee6e910 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 25/57] av: Revert mGraphicBufferEnabled

---
 media/libstagefright/omx/OMXNodeInstance.cpp        | 21 ---------------------
 .../include/media/stagefright/omx/OMXNodeInstance.h |  1 -
 2 files changed, 22 deletions(-)

diff --git a/media/libstagefright/omx/OMXNodeInstance.cpp b/media/libstagefright/omx/OMXNodeInstance.cpp
index 2058e9268..5c6201155 100644
--- a/media/libstagefright/omx/OMXNodeInstance.cpp
+++ b/media/libstagefright/omx/OMXNodeInstance.cpp
@@ -372,8 +372,6 @@ OMXNodeInstance::OMXNodeInstance(
     mPortMode[1] = IOMX::kPortModePresetByteBuffer;
     mSecureBufferType[0] = kSecureBufferTypeUnknown;
     mSecureBufferType[1] = kSecureBufferTypeUnknown;
-    mGraphicBufferEnabled[0] = false;
-    mGraphicBufferEnabled[1] = false;
     mIsSecure = AString(name).endsWith(".secure");
     mLegacyAdaptiveExperiment = ADebug::isExperimentEnabled("legacy-adaptive");
 }
@@ -818,12 +816,6 @@ status_t OMXNodeInstance::enableNativeBuffers_l(
             } else if (mSecureBufferType[portIndex] == kSecureBufferTypeUnknown) {
                 mSecureBufferType[portIndex] = kSecureBufferTypeOpaque;
             }
-        } else {
-            if (err == OMX_ErrorNone) {
-                mGraphicBufferEnabled[portIndex] = enable;
-            } else if (enable) {
-                mGraphicBufferEnabled[portIndex] = false;
-            }
         }
     } else {
         CLOG_ERROR_IF(enable, getExtensionIndex, err, "%s", name);
@@ -1092,12 +1084,6 @@ status_t OMXNodeInstance::useBuffer_l(
     OMX_ERRORTYPE err = OMX_ErrorNone;
     bool isMetadata = mMetadataType[portIndex] != kMetadataBufferTypeInvalid;
 
-    if (!isMetadata && mGraphicBufferEnabled[portIndex]) {
-        ALOGE("b/62948670");
-        android_errorWriteLog(0x534e4554, "62948670");
-        return INVALID_OPERATION;
-    }
-
     size_t paramsSize;
     void* paramsPointer;
     if (params != NULL && hParams != NULL) {
@@ -1283,13 +1269,6 @@ status_t OMXNodeInstance::useGraphicBuffer_l(
                 portIndex, graphicBuffer, buffer);
     }
 
-    if (!mGraphicBufferEnabled[portIndex]) {
-        // Report error if this is not in graphic buffer mode.
-        ALOGE("b/62948670");
-        android_errorWriteLog(0x534e4554, "62948670");
-        return INVALID_OPERATION;
-    }
-
     // See if the newer version of the extension is present.
     OMX_INDEXTYPE index;
 #ifndef STE_HARDWARE
diff --git a/media/libstagefright/omx/include/media/stagefright/omx/OMXNodeInstance.h b/media/libstagefright/omx/include/media/stagefright/omx/OMXNodeInstance.h
index 1065ca58e..051da8082 100644
--- a/media/libstagefright/omx/include/media/stagefright/omx/OMXNodeInstance.h
+++ b/media/libstagefright/omx/include/media/stagefright/omx/OMXNodeInstance.h
@@ -160,7 +160,6 @@ private:
         kSecureBufferTypeNativeHandle,
     };
     SecureBufferType mSecureBufferType[2];
-    bool mGraphicBufferEnabled[2];
 
     // Following are OMX parameters managed by us (instead of the component)
     // OMX_IndexParamMaxFrameDurationForBitrateControl
-- 
2.11.0

