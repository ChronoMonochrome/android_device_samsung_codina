From 95604f3f5c4e1c310905b997d0e3b1dfabe11e3a Mon Sep 17 00:00:00 2001
From: Milos Ratkovic <milosr@gmail.com>
Date: Tue, 17 Apr 2018 01:17:09 +0200
Subject: [PATCH] Camera: Revert check metadata type before releasing frame

Hidl method releaseRecordingFrameHandle fails for metadata
type other than kMetadataBufferTypeNativeHandleSource which
prevents older devices to record video.

diff --git a/services/camera/libcameraservice/device1/CameraHardwareInterface.cpp b/services/camera/libcameraservice/device1/CameraHardwareInterface.cpp
index 6c7de36..8edcca3 100644
--- a/services/camera/libcameraservice/device1/CameraHardwareInterface.cpp
+++ b/services/camera/libcameraservice/device1/CameraHardwareInterface.cpp
@@ -595,16 +595,12 @@
     if (CC_LIKELY(mHidlDevice != nullptr)) {
         if (size == sizeof(VideoNativeHandleMetadata)) {
             VideoNativeHandleMetadata* md = (VideoNativeHandleMetadata*) mem->pointer();
-            if (md->eType == kMetadataBufferTypeNativeHandleSource) {
-                // Caching the handle here because md->pHandle will be subject to HAL's edit
-                native_handle_t* nh = md->pHandle;
-                hidl_handle frame = nh;
-                mHidlDevice->releaseRecordingFrameHandle(heapId, bufferIndex, frame);
-                native_handle_close(nh);
-                native_handle_delete(nh);
-            } else {
-                mHidlDevice->releaseRecordingFrame(heapId, bufferIndex);
-            }
+            // Caching the handle here because md->pHandle will be subject to HAL's edit
+            native_handle_t* nh = md->pHandle;
+            hidl_handle frame = nh;
+            mHidlDevice->releaseRecordingFrameHandle(heapId, bufferIndex, frame);
+            native_handle_close(nh);
+            native_handle_delete(nh);
         } else {
             mHidlDevice->releaseRecordingFrame(heapId, bufferIndex);
         }
