From c86b5e440404e56c316b9daacd19de279b820008 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 55/57] STE AV Fix [4]

---
 media/libstagefright/include/media/stagefright/ACodec.h             | 3 +++
 media/libstagefright/omx/1.0/Omx.cpp                                | 6 ++++++
 media/libstagefright/omx/OMX.cpp                                    | 6 ++++++
 .../omx/include/media/stagefright/omx/OMXNodeInstance.h             | 3 +++
 4 files changed, 18 insertions(+)

diff --git a/media/libstagefright/include/media/stagefright/ACodec.h b/media/libstagefright/include/media/stagefright/ACodec.h
index 3db4b2bc8..ae6378110 100644
--- a/media/libstagefright/include/media/stagefright/ACodec.h
+++ b/media/libstagefright/include/media/stagefright/ACodec.h
@@ -91,6 +91,9 @@ struct ACodec : public AHierarchicalStateMachine, public CodecBase {
     enum Quirks {
         kRequiresAllocateBufferOnInputPorts   = 1,
         kRequiresAllocateBufferOnOutputPorts  = 2,
+#ifdef STE_HARDWARE
+        kRequiresStoreMetaDataBeforeIdle      = 16384,
+#endif
     };
 
     static status_t getOMXChannelMapping(size_t numChannels, OMX_AUDIO_CHANNELTYPE map[]);
diff --git a/media/libstagefright/omx/1.0/Omx.cpp b/media/libstagefright/omx/1.0/Omx.cpp
index fe50656b5..b5185b658 100644
--- a/media/libstagefright/omx/1.0/Omx.cpp
+++ b/media/libstagefright/omx/1.0/Omx.cpp
@@ -132,6 +132,12 @@ Return<void> Omx::allocateNode(
                     quirks |= OMXNodeInstance::
                             kRequiresAllocateBufferOnOutputPorts;
                 }
+#ifdef STE_HARDWARE
+                if (quirk == "requires-store-metadata-before-idle") {
+                    quirks |= OMXNodeInstance::
+                            kRequiresStoreMetaDataBeforeIdle;
+                }
+#endif
             }
             instance->setQuirks(quirks);
         }
diff --git a/media/libstagefright/omx/OMX.cpp b/media/libstagefright/omx/OMX.cpp
index 09c4019cc..cc1c40470 100644
--- a/media/libstagefright/omx/OMX.cpp
+++ b/media/libstagefright/omx/OMX.cpp
@@ -132,6 +132,12 @@ status_t OMX::allocateNode(
                 quirks |= OMXNodeInstance::
                         kRequiresAllocateBufferOnOutputPorts;
             }
+#ifdef STE_HARDWARE
+            if (quirk == "requires-store-metadata-before-idle") {
+                quirks |= OMXNodeInstance::
+                       kRequiresStoreMetaDataBeforeIdle;
+            }
+#endif
         }
         instance->setQuirks(quirks);
     }
diff --git a/media/libstagefright/omx/include/media/stagefright/omx/OMXNodeInstance.h b/media/libstagefright/omx/include/media/stagefright/omx/OMXNodeInstance.h
index d3ca3b3e1..6470b7ea5 100644
--- a/media/libstagefright/omx/include/media/stagefright/omx/OMXNodeInstance.h
+++ b/media/libstagefright/omx/include/media/stagefright/omx/OMXNodeInstance.h
@@ -98,6 +98,9 @@ struct OMXNodeInstance : public BnOMXNode {
     enum Quirks {
         kRequiresAllocateBufferOnInputPorts   = 1,
         kRequiresAllocateBufferOnOutputPorts  = 2,
+#ifdef STE_HARDWARE
+        kRequiresStoreMetaDataBeforeIdle      = 16384,
+#endif
 
         kQuirksMask = kRequiresAllocateBufferOnInputPorts
                     | kRequiresAllocateBufferOnOutputPorts,
-- 
2.11.0

