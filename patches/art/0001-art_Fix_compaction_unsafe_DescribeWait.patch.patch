From 74cadca3205e8b343bbde7270200071096686c9a Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 1 Feb 2016 13:08:19 +0700
Subject: [PATCH 1/2] art_Fix_compaction_unsafe_DescribeWait.patch

Change-Id: Id3b46b5864eb9ef98a86d94b13542d7b662f7f22
---
 runtime/monitor.cc | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/runtime/monitor.cc b/runtime/monitor.cc
index 0cf077a..1a62212 100644
--- a/runtime/monitor.cc
+++ b/runtime/monitor.cc
@@ -960,8 +960,11 @@ void Monitor::DescribeWait(std::ostream& os, const Thread* thread) {
                                            PrettyTypeOf(pretty_object).c_str());
       } else {
         // - waiting on <0x6008c468> (a java.lang.Class<java.lang.ref.ReferenceQueue>)
+        // Call PrettyTypeOf before IdentityHashCode since IdentityHashCode can cause thread
+        // suspension and move pretty_object.
+        const std::string pretty_type(PrettyTypeOf(pretty_object));
         os << wait_message << StringPrintf("<0x%08x> (a %s)", pretty_object->IdentityHashCode(),
-                                           PrettyTypeOf(pretty_object).c_str());
+                                           pretty_type.c_str());
       }
     }
     // - waiting to lock <0x613f83d8> (a java.lang.Object) held by thread 5
-- 
2.5.0

