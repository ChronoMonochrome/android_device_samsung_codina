From 89d9651d7e4f9de9c3051558539576a0b966697b Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Sat, 25 Aug 2018 17:11:49 +0300
Subject: [PATCH 04/15] bootable-recovery_004-fix-offline-charging.patch

Change-Id: I94aa1560b603e35c113f2f6e7a8426132f24827a
---
 minui/graphics.cpp | 21 ++++++++++++++++++++-
 minui21/graphics.c | 21 ++++++++++++++++++++-
 2 files changed, 40 insertions(+), 2 deletions(-)

diff --git a/minui/graphics.cpp b/minui/graphics.cpp
index b45e22e0..15a4e945 100644
--- a/minui/graphics.cpp
+++ b/minui/graphics.cpp
@@ -525,7 +525,7 @@ void gr_flip() {
   gr_draw = gr_backend->Flip();
 }
 
-int gr_init(void)
+int gr_init_real(void)
 {
   gr_init_font();
 
@@ -578,6 +578,25 @@ int gr_init(void)
   return 0;
 }
 
+/*
+ * FIXME: This is a total hack.
+ *
+ * Round 1
+ * framebuffer: fd 4 (480 x 800)
+ *
+ * Round 2
+ * framebuffer: fd 6 (480 x 800)
+ *
+*/
+int gr_init(void) {
+    int ret;
+    // Round 1
+    gr_init_real();
+    // Return the result of round 2
+    ret = gr_init_real();
+    return ret;
+}
+
 void gr_exit() {
   delete gr_backend;
 }
diff --git a/minui21/graphics.c b/minui21/graphics.c
index 580af297..0deb0a66 100644
--- a/minui21/graphics.c
+++ b/minui21/graphics.c
@@ -403,7 +403,7 @@ static void gr_init_font(void)
     gr_font->texture->format = GGL_PIXEL_FORMAT_A_8;
 }
 
-int gr_init(void)
+int gr_init_real(void)
 {
     gglInit(&gr_context);
     GGLContext *gl = gr_context;
@@ -450,6 +450,25 @@ int gr_init(void)
     return 0;
 }
 
+/*
+ * FIXME: This is a total hack.
+ *
+ * Round 1
+ * framebuffer: fd 4 (480 x 800)
+ *
+ * Round 2
+ * framebuffer: fd 6 (480 x 800)
+ *
+*/
+int gr_init(void) {
+    int ret;
+    // Round 1
+    gr_init_real();
+    // Return the result of round 2
+    ret = gr_init_real();
+    return ret;
+}
+
 void gr_exit(void)
 {
     free_overlay(gr_fb_fd);
-- 
2.11.0

