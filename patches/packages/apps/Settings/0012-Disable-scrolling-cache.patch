From fab7677976b7d0f249c0c8cff14853c98c51a841 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 12/30] Disable scrolling cache

---
 res/drawable/rr_scroll_icon.xml                    |  8 ++
 res/values/cr_arrays.xml                           | 15 ++++
 res/values/cr_strings.xml                          |  9 ++
 res/xml/animation_settings.xml                     | 28 +++++++
 res/xml/display_settings.xml                       |  5 ++
 .../settings/display/AnimationSettings.java        | 95 ++++++++++++++++++++++
 6 files changed, 160 insertions(+)
 create mode 100644 res/drawable/rr_scroll_icon.xml
 create mode 100644 res/xml/animation_settings.xml
 create mode 100644 src/com/android/settings/display/AnimationSettings.java

diff --git a/res/drawable/rr_scroll_icon.xml b/res/drawable/rr_scroll_icon.xml
new file mode 100644
index 0000000000..d8e86ada15
--- /dev/null
+++ b/res/drawable/rr_scroll_icon.xml
@@ -0,0 +1,8 @@
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:height="24dp"
+    android:width="24dp"
+    android:viewportWidth="24"
+    android:viewportHeight="24">
+    <path android:fillColor="?android:attr/colorControlNormal"
+          android:pathData="M13,9V5L6,12L13,19V14.9C18,14.9 21.5,16.5 24,20C23,15 20,10 13,9M7,8V5L0,12L7,19V16L3,12L7,8Z" />
+</vector>
diff --git a/res/values/cr_arrays.xml b/res/values/cr_arrays.xml
index 955224f0de..245312accb 100644
--- a/res/values/cr_arrays.xml
+++ b/res/values/cr_arrays.xml
@@ -30,4 +30,19 @@
         <item>mass_storage</item>
     </string-array>
 
+    <!-- Option to enable/disable scrolling cache -->
+    <string-array name="entries_scrollingcache" translatable="false">
+        <item>@string/pref_scrollingcache_force_enable</item>
+        <item>@string/pref_scrollingcache_default_enable</item>
+        <item>@string/pref_scrollingcache_default_disable</item>
+        <item>@string/pref_scrollingcache_force_disable</item>
+    </string-array>
+
+    <string-array name="values_scrollingcache" translatable="false">
+        <item>0</item>
+        <item>1</item>
+        <item>2</item>
+        <item>3</item>
+    </string-array>
+
 </resources>
diff --git a/res/values/cr_strings.xml b/res/values/cr_strings.xml
index 91f806b7d7..e2b6f02b7e 100644
--- a/res/values/cr_strings.xml
+++ b/res/values/cr_strings.xml
@@ -38,4 +38,13 @@
     <string name="changelog_summary">See some of the recent commits.</string>
     <string name="changelog_error">Unable to load changelog</string>
 
+    <!-- Option to enable/disable scrolling cache -->
+    <string name="pref_scrollingcache_title">Scrolling cache</string>
+    <string name="pref_scrollingcache_summary">Scrolling cache may improve scrolling performance at the cost of memory</string>
+    <string name="pref_scrollingcache_force_enable">Force enable</string>
+    <string name="pref_scrollingcache_default_enable">Default enable</string>
+    <string name="pref_scrollingcache_default_disable">Default disable</string>
+    <string name="pref_scrollingcache_force_disable">Force disable</string>
+    <string name="animation_settings_title">Advanced options</string>
+
 </resources>
diff --git a/res/xml/animation_settings.xml b/res/xml/animation_settings.xml
new file mode 100644
index 0000000000..2fcf4cce75
--- /dev/null
+++ b/res/xml/animation_settings.xml
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2014 BOSP
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+          http://www.apache.org/licenses/LICENSE-2.0
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<PreferenceScreen
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:title="@string/animation_settings_title"
+    xmlns:settings="http://schemas.android.com/apk/res/com.android.settings">
+
+    <ListPreference
+        android:key="pref_scrollingcache"
+        android:dialogTitle="@string/pref_scrollingcache_title"
+        android:title="@string/pref_scrollingcache_title"
+        android:summary="@string/pref_scrollingcache_summary"
+        android:entries="@array/entries_scrollingcache"
+        android:entryValues="@array/values_scrollingcache"
+        android:icon="@drawable/rr_scroll_icon" />
+
+</PreferenceScreen>
diff --git a/res/xml/display_settings.xml b/res/xml/display_settings.xml
index 065197bd7c..c723277238 100644
--- a/res/xml/display_settings.xml
+++ b/res/xml/display_settings.xml
@@ -161,6 +161,11 @@
         android:defaultValue="false"
         lineage:requiresFeature="lineagehardware:FEATURE_HIGH_TOUCH_SENSITIVITY" />
 
+    <PreferenceScreen
+        android:key="pref_animation_settings"
+        android:title="@string/animation_settings_title"
+        android:fragment="com.android.settings.display.AnimationSettings" />
+
     <!-- Use LineageParts for styles 
     <ListPreference
         android:key="theme"
diff --git a/src/com/android/settings/display/AnimationSettings.java b/src/com/android/settings/display/AnimationSettings.java
new file mode 100644
index 0000000000..4cf770138a
--- /dev/null
+++ b/src/com/android/settings/display/AnimationSettings.java
@@ -0,0 +1,95 @@
+/*
+ *<!-- Copyright (C) 2012-2014 BOSP
+ * 
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.settings.display;
+
+import android.app.Activity;
+import android.content.Context;
+import android.content.ContentResolver;
+import android.os.Bundle;
+import android.os.SystemProperties;
+import android.support.v7.preference.ListPreference;
+import android.support.v7.preference.Preference;
+import android.support.v7.preference.Preference.OnPreferenceChangeListener;
+import android.support.v7.preference.PreferenceScreen;
+import android.support.v14.preference.SwitchPreference;
+import android.provider.Settings;
+import android.view.View;
+import android.widget.Toast;
+
+import com.android.settings.R;
+import com.android.settings.SettingsPreferenceFragment;
+
+import java.util.ArrayList;
+import java.util.Arrays;
+import java.util.HashSet;
+import java.util.List;
+
+import com.android.internal.logging.nano.MetricsProto.MetricsEvent;
+
+public class AnimationSettings extends SettingsPreferenceFragment implements
+        Preference.OnPreferenceChangeListener {
+
+    private static final String TAG = "AnimationSettings";
+ 
+    private static final String SCROLLINGCACHE_PREF = "pref_scrollingcache";
+    private static final String SCROLLINGCACHE_PERSIST_PROP = "persist.sys.scrollingcache";
+    private static final String SCROLLINGCACHE_DEFAULT = "1";
+
+    private Context mContext;
+
+    private ListPreference mScrollingCachePref;
+
+    @Override
+    public int getMetricsCategory() {
+        return MetricsEvent.NEW_SETTINGS;
+    }
+
+    @Override
+    public void onCreate(Bundle icicle) {
+        super.onCreate(icicle);
+        addPreferencesFromResource(R.xml.animation_settings);
+
+        ContentResolver resolver = getActivity().getContentResolver();
+        Activity activity = getActivity();
+        PreferenceScreen prefSet = getPreferenceScreen();
+
+        mContext = getActivity().getApplicationContext();
+
+        // Scrolling cache
+        mScrollingCachePref = (ListPreference) prefSet.findPreference(SCROLLINGCACHE_PREF);
+        mScrollingCachePref.setValue(SystemProperties.get(SCROLLINGCACHE_PERSIST_PROP,
+                SystemProperties.get(SCROLLINGCACHE_PERSIST_PROP, SCROLLINGCACHE_DEFAULT)));
+        mScrollingCachePref.setOnPreferenceChangeListener(this);
+    }
+
+    @Override
+    public void onResume() {
+        super.onResume();
+    }
+
+    @Override
+    public boolean onPreferenceChange(Preference preference, Object newValue) {
+        ContentResolver resolver = getActivity().getContentResolver();
+        if (preference == mScrollingCachePref) {
+            if (newValue != null) {
+                SystemProperties.set(SCROLLINGCACHE_PERSIST_PROP, (String) newValue);
+            }
+            return true;
+        }
+        return false;
+    }
+}
-- 
2.11.0

