From b839145db39888fbfd8599f361aa9e39aa718f20 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Tue, 11 Aug 2015 13:11:29 +0200
Subject: [PATCH 09/30] Bring back UMS support [1/3]

---
 res/values/cr_strings.xml                                       | 3 +++
 src/com/android/settings/deviceinfo/UsbBackend.java             | 6 ++++++
 src/com/android/settings/deviceinfo/UsbModeChooserActivity.java | 5 ++++-
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/res/values/cr_strings.xml b/res/values/cr_strings.xml
index c2a32511e8..a7cd437479 100644
--- a/res/values/cr_strings.xml
+++ b/res/values/cr_strings.xml
@@ -24,4 +24,7 @@
     <string name="allow_signature_fake_summary">Allow apps to bypass security systems by pretending to be a different app</string>
     <string name="allow_signature_fake_warning">Allowing apps to bypass security systems can lead to serious security and privacy problems! Check that only benign apps use the corresponding permission when this is active.</string>
 
+    <!-- transferring files via UMS -->
+    <string name="usb_use_UMS">File transfers via UMS</string>
+
 </resources>
diff --git a/src/com/android/settings/deviceinfo/UsbBackend.java b/src/com/android/settings/deviceinfo/UsbBackend.java
index 5d2502ba9b..864ab6b62a 100644
--- a/src/com/android/settings/deviceinfo/UsbBackend.java
+++ b/src/com/android/settings/deviceinfo/UsbBackend.java
@@ -37,6 +37,7 @@ public class UsbBackend {
     public static final int MODE_DATA_MTP    = 0x01 << 1;
     public static final int MODE_DATA_PTP    = 0x02 << 1;
     public static final int MODE_DATA_MIDI   = 0x03 << 1;
+    public static final int MODE_DATA_UMS    = 0x04 << 1;
 
     private final boolean mRestricted;
     private final boolean mRestrictedBySystem;
@@ -96,6 +97,8 @@ public class UsbBackend {
             return MODE_DATA_PTP;
         } else if (mUsbManager.isFunctionEnabled(UsbManager.USB_FUNCTION_MIDI)) {
             return MODE_DATA_MIDI;
+        } else if (mUsbManager.isFunctionEnabled(UsbManager.USB_FUNCTION_UMS)) {
+            return MODE_DATA_UMS;
         }
         return MODE_DATA_NONE; // ...
     }
@@ -118,6 +121,9 @@ public class UsbBackend {
             case MODE_DATA_MIDI:
                 mUsbManager.setCurrentFunction(UsbManager.USB_FUNCTION_MIDI, true);
                 break;
+            case MODE_DATA_UMS:
+                mUsbManager.setCurrentFunction(UsbManager.USB_FUNCTION_UMS, true);
+                break;
             default:
                 mUsbManager.setCurrentFunction(null, false);
                 break;
diff --git a/src/com/android/settings/deviceinfo/UsbModeChooserActivity.java b/src/com/android/settings/deviceinfo/UsbModeChooserActivity.java
index 8ba378156f..9b00b017a6 100644
--- a/src/com/android/settings/deviceinfo/UsbModeChooserActivity.java
+++ b/src/com/android/settings/deviceinfo/UsbModeChooserActivity.java
@@ -55,7 +55,8 @@ public class UsbModeChooserActivity extends Activity {
         UsbBackend.MODE_POWER_SOURCE | UsbBackend.MODE_DATA_NONE,
         UsbBackend.MODE_POWER_SINK | UsbBackend.MODE_DATA_MTP,
         UsbBackend.MODE_POWER_SINK | UsbBackend.MODE_DATA_PTP,
-        UsbBackend.MODE_POWER_SINK | UsbBackend.MODE_DATA_MIDI
+        UsbBackend.MODE_POWER_SINK | UsbBackend.MODE_DATA_MIDI,
+        UsbBackend.MODE_POWER_SINK | UsbBackend.MODE_DATA_UMS
     };
 
     private UsbBackend mBackend;
@@ -198,6 +199,8 @@ public class UsbModeChooserActivity extends Activity {
                 return R.string.usb_use_photo_transfers;
             case UsbBackend.MODE_POWER_SINK | UsbBackend.MODE_DATA_MIDI:
                 return R.string.usb_use_MIDI;
+            case UsbBackend.MODE_POWER_SINK | UsbBackend.MODE_DATA_UMS:
+                return R.string.usb_use_UMS;
         }
         return 0;
     }
-- 
2.11.0

