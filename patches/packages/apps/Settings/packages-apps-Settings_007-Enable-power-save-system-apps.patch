From d764534c099e5c326ca530ae2cd89674e31d6e87 Mon Sep 17 00:00:00 2001
From: Josh Chasky <jchasky@gmail.com>
Date: Sat, 21 Jul 2018 13:07:25 -0400
From 7c0726e247dcc60ac830cb88b46a9d2eb2ecb2bf Mon Sep 17 00:00:00 2001
From: maxwen <max.weninger@gmail.com>
Date: Thu, 25 May 2017 22:36:49 +0200
Subject: [PATCH] Enable power save config of system apps [2/2]

Change-Id: I357bda3444384533399396705bb23938ec1f6b88
---

diff --git a/src/com/android/settings/applications/ManageApplications.java b/src/com/android/settings/applications/ManageApplications.java
index c3aaf95..03aa8ef 100644
--- a/src/com/android/settings/applications/ManageApplications.java
+++ b/src/com/android/settings/applications/ManageApplications.java
@@ -1353,16 +1353,7 @@
 
         @Override
         public boolean isEnabled(int position) {
-            if (position == mEntries.size() && mExtraViewController != null &&
-                    mExtraViewController.shouldShow()) {
-                return true;
-            }
-
-            if (mManageApplications.mListType != LIST_TYPE_HIGH_POWER) {
-                return true;
-            }
-            ApplicationsState.AppEntry entry = mEntries.get(position);
-            return !PowerWhitelistBackend.getInstance().isSysWhitelisted(entry.info.packageName);
+            return true;
         }
 
         public View getView(int position, View convertView, ViewGroup parent) {
diff --git a/src/com/android/settings/fuelgauge/HighPowerDetail.java b/src/com/android/settings/fuelgauge/HighPowerDetail.java
index 296f973..114bcca 100644
--- a/src/com/android/settings/fuelgauge/HighPowerDetail.java
+++ b/src/com/android/settings/fuelgauge/HighPowerDetail.java
@@ -79,9 +79,6 @@
                 ? R.string.ignore_optimizations_on_desc : R.string.ignore_optimizations_off_desc);
         view.setClickable(true);
         view.setOnClickListener(this);
-        if (!on && mBackend.isSysWhitelisted(mPackageName)) {
-            view.setEnabled(false);
-        }
         return (Checkable) view;
     }
 
@@ -91,9 +88,7 @@
                 .setTitle(mLabel)
                 .setNegativeButton(R.string.cancel, null)
                 .setView(R.layout.ignore_optimizations_content);
-        if (!mBackend.isSysWhitelisted(mPackageName)) {
-            b.setPositiveButton(R.string.done, this);
-        }
+        b.setPositiveButton(R.string.done, this);
         return b.create();
     }
 
@@ -160,8 +155,7 @@
 
     public static CharSequence getSummary(Context context, String pkg) {
         PowerWhitelistBackend powerWhitelist = PowerWhitelistBackend.getInstance();
-        return context.getString(powerWhitelist.isSysWhitelisted(pkg) ? R.string.high_power_system
-                : powerWhitelist.isWhitelisted(pkg) ? R.string.high_power_on
+        return context.getString(powerWhitelist.isWhitelisted(pkg) ? R.string.high_power_on
                 : R.string.high_power_off);
     }
 
diff --git a/src/com/android/settings/fuelgauge/PowerWhitelistBackend.java b/src/com/android/settings/fuelgauge/PowerWhitelistBackend.java
index 5590a46..9870bdf 100644
--- a/src/com/android/settings/fuelgauge/PowerWhitelistBackend.java
+++ b/src/com/android/settings/fuelgauge/PowerWhitelistBackend.java
@@ -59,7 +59,11 @@
 
     public void addApp(String pkg) {
         try {
-            mDeviceIdleService.addPowerSaveWhitelistApp(pkg);
+            if (isSysWhitelisted(pkg)) {
+                mDeviceIdleService.addSystemPowerSaveWhitelistApp(pkg);
+            } else {
+                mDeviceIdleService.addPowerSaveWhitelistApp(pkg);
+            }
             mWhitelistedApps.add(pkg);
         } catch (RemoteException e) {
             Log.w(TAG, "Unable to reach IDeviceIdleController", e);
@@ -68,7 +72,11 @@
 
     public void removeApp(String pkg) {
         try {
-            mDeviceIdleService.removePowerSaveWhitelistApp(pkg);
+            if (isSysWhitelisted(pkg)) {
+                mDeviceIdleService.removeSystemPowerSaveWhitelistApp(pkg);
+            } else {
+                mDeviceIdleService.removePowerSaveWhitelistApp(pkg);
+            }
             mWhitelistedApps.remove(pkg);
         } catch (RemoteException e) {
             Log.w(TAG, "Unable to reach IDeviceIdleController", e);
@@ -84,7 +92,7 @@
             for (String app : whitelistedApps) {
                 mWhitelistedApps.add(app);
             }
-            String[] sysWhitelistedApps = mDeviceIdleService.getSystemPowerWhitelist();
+            String[] sysWhitelistedApps = mDeviceIdleService.getSystemPowerWhitelistOriginal();
             for (String app : sysWhitelistedApps) {
                 mSysWhitelistedApps.add(app);
             }
