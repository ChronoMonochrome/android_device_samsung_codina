From 3dc6cf697bc37eeda263bb7e100ca7b0d3d0b8ad Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Sun, 4 Sep 2016 21:31:17 +0700
Subject: [PATCH 8/8] Move device specific flags to armv7-a-neon.mk

Change-Id: I353ea00cb9facdcf09296a0c4259587b1f48d6f1
---
 core/binary.mk                      |  2 ++
 core/combo/arch/arm/armv7-a-neon.mk | 16 +++++++++++-
 core/combo/select.mk                | 20 +++-----------
 core/ultimaterom.mk                 | 52 +++++++++++++++++++++++++++++++++++++
 4 files changed, 73 insertions(+), 17 deletions(-)
 create mode 100644 core/ultimaterom.mk

diff --git a/core/binary.mk b/core/binary.mk
index 2ab1e7c..0c2ed27 100644
--- a/core/binary.mk
+++ b/core/binary.mk
@@ -169,6 +169,8 @@ ifdef LOCAL_SDK_VERSION
   endif
 endif
 
+include $(BUILD_SYSTEM)/ultimaterom.mk
+
 # MinGW spits out warnings about -fPIC even for -fpie?!) being ignored because
 # all code is position independent, and then those warnings get promoted to
 # errors.
diff --git a/core/combo/arch/arm/armv7-a-neon.mk b/core/combo/arch/arm/armv7-a-neon.mk
index 8dee4ea..d26209a 100644
--- a/core/combo/arch/arm/armv7-a-neon.mk
+++ b/core/combo/arch/arm/armv7-a-neon.mk
@@ -8,6 +8,20 @@ ARCH_ARM_HAVE_NEON              := true
 
 local_arch_has_lpae := false
 
+# Codina device-specific flags
+
+COMMON_GLOBAL_CFLAGS_ += -DSTE_HARDWARE -DSTE_SAMSUNG_HARDWARE -DTARGET_NEEDS_HWC_V0
+TARGET_GLOBAL_CFLAGS_ += -mtune=cortex-a9 -mfpu=neon -mfloat-abi=softfp
+TARGET_GLOBAL_CPPFLAGS_ += -mtune=cortex-a9 -mfpu=neon -mfloat-abi=softfp
+COMMON_GLOBAL_CFLAGS_ += -DFORCE_SCREENSHOT_CPU_PATH -DBOARD_CANT_REALLOCATE_OMX_BUFFERS
+COMMON_GLOBAL_CFLAGS_ += -DMR0_AUDIO_BLOB -DMR1_AUDIO_BLOB
+COMMON_GLOBAL_CFLAGS_ += -DRECOVERY_CANT_USE_CONFIG_EXT4_FS_XATTR
+COMMON_GLOBAL_CFLAGS_ += -DNEEDS_VECTORIMPL_SYMBOLS -DADD_LEGACY_ACQUIRE_BUFFER_SYMBOL
+COMMON_GLOBAL_CFLAGS_ += -DNO_SECURE_DISCARD
+COMMON_GLOBAL_CPPFLAGS_ += -DNO_SECURE_DISCARD
+
+DEVICE_FLAGS := $(COMMON_GLOBAL_CFLAGS_) $(TARGET_GLOBAL_CFLAGS_) $(COMMON_GLOBAL_CPPFLAGS_)
+
 ifneq (,$(filter cortex-a15 denver krait,$(TARGET_$(combo_2nd_arch_prefix)CPU_VARIANT)))
 	# TODO: krait is not a cortex-a15, we set the variant to cortex-a15 so that
 	#       hardware divide operations are generated. This should be removed and a
@@ -20,7 +34,7 @@ ifneq (,$(filter cortex-a15 denver krait,$(TARGET_$(combo_2nd_arch_prefix)CPU_VA
 		-Wl,--no-fix-cortex-a8
 else
 ifeq ($(strip $(TARGET_$(combo_2nd_arch_prefix)CPU_VARIANT)),cortex-a9)
-	arch_variant_cflags := -mcpu=cortex-a9 -mfpu=neon
+	arch_variant_cflags := -mcpu=cortex-a9 -mfpu=neon $(DEVICE_FLAGS)
 else
 ifneq (,$(filter cortex-a8 scorpion,$(TARGET_$(combo_2nd_arch_prefix)CPU_VARIANT)))
 	arch_variant_cflags := -mcpu=cortex-a8 -mfpu=neon
diff --git a/core/combo/select.mk b/core/combo/select.mk
index d5d770b..df12e7e 100644
--- a/core/combo/select.mk
+++ b/core/combo/select.mk
@@ -33,22 +33,10 @@ $(combo_var_prefix)CXX := $(CXX)
 $(combo_var_prefix)AR := $(AR)
 $(combo_var_prefix)STRIP := $(STRIP)
 
-COMMON_GLOBAL_CFLAGS_ += -DSTE_HARDWARE -DSTE_SAMSUNG_HARDWARE -DTARGET_NEEDS_HWC_V0
-TARGET_GLOBAL_CFLAGS_ += -mtune=cortex-a9 -mfpu=neon -mfloat-abi=softfp
-TARGET_GLOBAL_CPPFLAGS_ += -mtune=cortex-a9 -mfpu=neon -mfloat-abi=softfp
-COMMON_GLOBAL_CFLAGS_ += -DFORCE_SCREENSHOT_CPU_PATH -DBOARD_CANT_REALLOCATE_OMX_BUFFERS
-COMMON_GLOBAL_CFLAGS_ += -DMR0_AUDIO_BLOB -DMR1_AUDIO_BLOB
-COMMON_GLOBAL_CFLAGS_ += -DRECOVERY_CANT_USE_CONFIG_EXT4_FS_XATTR
-COMMON_GLOBAL_CFLAGS_ += -DNEEDS_VECTORIMPL_SYMBOLS -DADD_LEGACY_ACQUIRE_BUFFER_SYMBOL
-COMMON_GLOBAL_CFLAGS_ += -DNO_SECURE_DISCARD
-COMMON_GLOBAL_CPPFLAGS_ += -DNO_SECURE_DISCARD
-
-DEVICE_FLAGS := $(COMMON_GLOBAL_CFLAGS_) $(TARGET_GLOBAL_CFLAGS_) $(COMMON_GLOBAL_CPPFLAGS_)
-
-$(combo_var_prefix)GLOBAL_CFLAGS := -fno-exceptions -Wno-multichar $(DEVICE_CFLAGS)
-$(combo_var_prefix)RELEASE_CFLAGS := -O2 -g -fno-strict-aliasing $(DEVICE_CFLAGS)
-$(combo_var_prefix)GLOBAL_CPPFLAGS := $(DEVICE_CFLAGS)
-$(combo_var_prefix)GLOBAL_LDFLAGS := 
+$(combo_var_prefix)GLOBAL_CFLAGS := -fno-exceptions -Wno-multichar
+$(combo_var_prefix)RELEASE_CFLAGS := -O2 -g -fno-strict-aliasing
+$(combo_var_prefix)GLOBAL_CPPFLAGS :=
+$(combo_var_prefix)GLOBAL_LDFLAGS :=
 $(combo_var_prefix)GLOBAL_ARFLAGS := crsPD
 $(combo_var_prefix)GLOBAL_LD_DIRS :=
 
diff --git a/core/ultimaterom.mk b/core/ultimaterom.mk
new file mode 100644
index 0000000..d189d29
--- /dev/null
+++ b/core/ultimaterom.mk
@@ -0,0 +1,52 @@
+# Copyright (C) 2016 UltimateROM
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#      http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+
+# Codina device-specific flags
+
+COMMON_GLOBAL_CFLAGS_ += -DSTE_HARDWARE -DSTE_SAMSUNG_HARDWARE -DTARGET_NEEDS_HWC_V0
+TARGET_GLOBAL_CFLAGS_ += -mtune=cortex-a9 -mfpu=neon -mfloat-abi=softfp
+TARGET_GLOBAL_CPPFLAGS_ += -mtune=cortex-a9 -mfpu=neon -mfloat-abi=softfp
+COMMON_GLOBAL_CFLAGS_ += -DFORCE_SCREENSHOT_CPU_PATH -DBOARD_CANT_REALLOCATE_OMX_BUFFERS
+COMMON_GLOBAL_CFLAGS_ += -DMR0_AUDIO_BLOB -DMR1_AUDIO_BLOB
+COMMON_GLOBAL_CFLAGS_ += -DRECOVERY_CANT_USE_CONFIG_EXT4_FS_XATTR
+COMMON_GLOBAL_CFLAGS_ += -DNEEDS_VECTORIMPL_SYMBOLS -DADD_LEGACY_ACQUIRE_BUFFER_SYMBOL
+COMMON_GLOBAL_CFLAGS_ += -DNO_SECURE_DISCARD
+COMMON_GLOBAL_CPPFLAGS_ += -DNO_SECURE_DISCARD
+
+DEVICE_FLAGS := $(COMMON_GLOBAL_CFLAGS_) $(TARGET_GLOBAL_CFLAGS_) $(COMMON_GLOBAL_CPPFLAGS_)
+
+ifndef LOCAL_IS_HOST_MODULE
+
+ifdef LOCAL_CONLYFLAGS
+LOCAL_CONLYFLAGS += $(DEVICE_FLAGS)
+else
+LOCAL_CONLYFLAGS := $(DEVICE_FLAGS)
+endif
+
+ifdef LOCAL_CFLAGS
+LOCAL_CFLAGS += $(DEVICE_FLAGS)
+else
+LOCAL_CFLAGS := $(DEVICE_FLAGS)
+endif
+
+ifdef LOCAL_CPPFLAGS
+LOCAL_CPPFLAGS += $(DEVICE_FLAGS)
+else
+LOCAL_CPPFLAGS := $(DEVICE_FLAGS)
+endif
+
+endif
+#####
+
-- 
2.5.0

