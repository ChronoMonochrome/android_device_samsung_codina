From 54f50e74bc7b251494a163da12fc3a0da6f461fe Mon Sep 17 00:00:00 2001
From: Jiangyi <sam.andrew.jiang@gmail.com>
Date: Fri, 18 Jul 2014 15:53:13 -0400
Subject: [PATCH 1/2] Prebuilt chromium

Change-Id: Ic6225f9db00c66e76b722cfb576a6b5495b3c375
---
 core/Makefile |  4 ++++
 envsetup.sh   | 22 ++++++++++++++++++++++
 2 files changed, 26 insertions(+)

diff --git a/core/Makefile b/core/Makefile
index b091aa7..575d2da 100755
--- a/core/Makefile
+++ b/core/Makefile
@@ -1493,6 +1493,10 @@ else
 	@echo -e ${CL_YLW}"Running releasetool..."${CL_RST}
 	$(hide) ./vendor/$(DHO_VENDOR)/tools/squisher $(SQUISHER_ARGS)
 endif
+ifneq ($(PRODUCT_PREBUILT_WEBVIEWCHROMIUM),yes)
+	@echo "Running Chromium prebuilt setup script..."
+	$(hide) . $(TOPDIR)vendor/omni/utils/chromium_prebuilt.sh $(TOP)
+endif
 
 .PHONY: printvars
 printvars:
diff --git a/envsetup.sh b/envsetup.sh
index 7e68b10..8976a4a 100755
--- a/envsetup.sh
+++ b/envsetup.sh
@@ -565,6 +565,13 @@ function lunch()
 
     echo
 
+    if [[ $USE_PREBUILT_CHROMIUM -eq 1 ]]; then
+        chromium_prebuilt
+    else
+        # Unset flag in case user opts out later on
+        export PRODUCT_PREBUILT_WEBVIEWCHROMIUM=""
+    fi
+
     fixup_common_out_dir
 
     set_stuff_for_environment
@@ -579,6 +586,7 @@ function lunch()
     fi
 
     printconfig
+
 }
 
 # Tab completion for lunch.
@@ -1696,6 +1704,20 @@ function pez {
     return $retval
 }
 
+function chromium_prebuilt() {
+    T=$(gettop)
+    export TARGET_DEVICE=$(get_build_var TARGET_DEVICE)
+    hash=$T/prebuilts/chromium/$TARGET_DEVICE/hash.txt
+
+    if [ -r $hash ] && [ $(git --git-dir=$T/external/chromium/.git --work-tree=$T/external/chromium rev-parse --verify HEAD) == $(cat $hash) ]; then
+        export PRODUCT_PREBUILT_WEBVIEWCHROMIUM=yes
+        echo "** Prebuilt Chromium is up-to-date; Will be used for build **"
+    else
+        export PRODUCT_PREBUILT_WEBVIEWCHROMIUM=no
+        echo "** Prebuilt Chromium out-of-date/not found; Will build from source **"
+    fi
+}
+
 if [ "x$SHELL" != "x/bin/bash" ]; then
     case `ps -o command -p $$` in
         *bash*)
-- 
1.9.1

