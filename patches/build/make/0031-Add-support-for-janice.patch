From 8649c51408747cf6e0b91149076c6f7ced67fa23 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Tue, 21 Aug 2018 20:17:33 +0300
Subject: [PATCH 31/31] Add support for janice

Change-Id: I31dc0bc88cf9785a1a32e5a1c2a15a6a989b18fa
---
 core/Makefile                               |  4 +++-
 target/product/go_defaults_common.mk        |  3 ++-
 tools/releasetools/ota_from_target_files.py | 12 ++++++++----
 3 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/core/Makefile b/core/Makefile
index aa0a2d2e4..630be3222 100644
--- a/core/Makefile
+++ b/core/Makefile
@@ -1347,7 +1347,9 @@ $(recovery_uncompressed_ramdisk): $(MKBOOTFS) $(ADBD) \
 		@echo ----- Copy uncompressed recovery ------
 		$(hide) cp $(PRODUCT_OUT)/ramdisk-recovery.cpio $(PRODUCT_OUT)/install/bin/recovery.cpio
 		@echo ----- Compressed recovery gzip ------
-		$(hide) gzip $(PRODUCT_OUT)/install/bin/recovery.cpio
+		mkdir -p $(PRODUCT_OUT)/install/codina
+		mkdir -p $(PRODUCT_OUT)/install/janice
+		$(hide) gzip -f $(PRODUCT_OUT)/install/bin/recovery.cpio
 		@echo ----- Generating Changelog ------
 		$(hide) ./vendor/samsung/tools/changelog
 		$(hide) mv $(PRODUCT_OUT)/Changelog.txt $(PRODUCT_OUT)/$(LINEAGE_VERSION)-$(TARGET_PRODUCT).txt
diff --git a/target/product/go_defaults_common.mk b/target/product/go_defaults_common.mk
index 1773b5778..0a3dea53f 100644
--- a/target/product/go_defaults_common.mk
+++ b/target/product/go_defaults_common.mk
@@ -18,6 +18,7 @@
 
 # Set lowram options
 PRODUCT_PROPERTY_OVERRIDES += \
+     ro.config.low_ram1=false \
      ro.lmk.critical_upgrade=true \
      ro.lmk.upgrade_pressure=40
 
@@ -47,5 +48,5 @@ PRODUCT_DEX_PREOPT_BOOT_IMAGE_PROFILE_LOCATION := frameworks/base/config/boot-im
 # Some notable apps that will be affected by this are gms and chrome.
 # b/65591595.
 PRODUCT_PROPERTY_OVERRIDES += \
-     pm.dexopt.shared=quicken
+     pm.dexopt.shared=speed
 
diff --git a/tools/releasetools/ota_from_target_files.py b/tools/releasetools/ota_from_target_files.py
index 6559dcf87..4f69247a5 100755
--- a/tools/releasetools/ota_from_target_files.py
+++ b/tools/releasetools/ota_from_target_files.py
@@ -647,12 +647,12 @@ def AddCompatibilityArchive(target_zip, output_zip, system_included=True,
                     compress_type=zipfile.ZIP_STORED)
 
 
-def CopyInstallTools(output_zip):
-  install_path = os.path.join(OPTIONS.input_tmp, "INSTALL")
+def CopyInstallTools(output_zip, d_in, d_out):
+  install_path = d_in
   for root, subdirs, files in os.walk(install_path):
      for f in files:
       install_source = os.path.join(root, f)
-      install_target = os.path.join("install", os.path.relpath(root, install_path), f)
+      install_target = os.path.join(d_out, os.path.relpath(root, install_path), f)
       output_zip.write(install_source, install_target)
 
 
@@ -752,8 +752,12 @@ else if get_stage("%(bcb_dev)s") == "3/3" then
   script.AppendExtra("ifelse(is_mounted(\"/system\"), unmount(\"/system\"));")
   device_specific.FullOTA_InstallBegin()
 
-  CopyInstallTools(output_zip)
+  CopyInstallTools(output_zip, d_in = os.path.join(OPTIONS.input_tmp, "INSTALL"), d_out = "install")
+  obj = os.getenv("OUT", "")
+  codina_path = os.path.join(obj, "codina")
+  CopyInstallTools(output_zip, d_in = codina_path, d_out = "codina")
   script.UnpackPackageDir("install", "/tmp/install")
+  script.UnpackPackageDir("codina/system", "/system")
   script.SetPermissionsRecursive("/tmp/install", 0, 0, 0755, 0644, None, None)
   script.SetPermissionsRecursive("/tmp/install/bin", 0, 0, 0755, 0755, None, None)
 
-- 
2.11.0

